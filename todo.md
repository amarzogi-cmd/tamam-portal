# بوابة تمام للعناية بالمساجد - قائمة المهام

## المرحلة 1: قاعدة البيانات والجداول الأساسية
- [x] إنشاء جدول المستخدمين مع الأدوار التسعة
- [x] إنشاء جدول الموظفين مع البيانات التفصيلية
- [x] إنشاء جدول المساجد مع جميع الحقول
- [x] إنشاء جدول الطلبات الرئيسي (mosque_requests)
- [x] إنشاء جدول مرفقات الطلبات (request_attachments)
- [x] إنشاء جدول تعليقات الطلبات (request_comments)
- [x] إنشاء جدول سجل الطلبات (request_history)
- [x] إنشاء جدول تقارير الزيارات الميدانية
- [x] إنشاء جدول تقارير الاستجابة السريعة
- [x] إنشاء جدول التقارير الختامية
- [x] إنشاء جدول المشاريع
- [x] إنشاء جدول مراحل المشاريع
- [x] إنشاء جدول العقود
- [x] إنشاء جدول الدفعات المالية
- [x] إنشاء جدول فرص التبرع
- [x] إنشاء جدول الموردين والمقاولين
- [x] إنشاء جدول عروض الأسعار
- [x] إنشاء جدول جداول الكميات
- [x] إنشاء جدول الإشعارات
- [x] إنشاء جدول التصنيفات
- [x] إنشاء جدول إعدادات الهوية البصرية
- [x] إنشاء جدول سجل التدقيق (audit_logs)
- [x] إنشاء جدول الشركاء والداعمين
- [x] تشغيل db:push لتطبيق التغييرات

## المرحلة 2: نظام المصادقة والأدوار
- [x] تعريف الأدوار التسعة في النظام
- [x] إنشاء نظام تسجيل طالبي الخدمة
- [x] إنشاء نظام دخول الموظفين
- [x] إنشاء صفحة اعتماد المستخدمين الجدد
- [x] تطبيق صلاحيات كل دور
- [x] إنشاء middleware للتحقق من الصلاحيات

## المرحلة 3: نظام إدارة المساجد
- [x] إنشاء نموذج تسجيل مسجد جديد
- [ ] تكامل خرائط Google لتحديد الموقع
- [x] إنشاء قائمة المساجد مع الفلاتر
- [x] إنشاء صفحة تفاصيل المسجد
- [x] نظام اعتماد المساجد الجديدة
- [ ] عرض المساجد على الخريطة

## المرحلة 4: نماذج البرامج التسعة
- [x] نموذج برنامج بنيان (بناء مسجد جديد)
- [x] نموذج برنامج دعائم (استكمال المساجد المتعثرة)
- [x] نموذج برنامج عناية (الصيانة والترميم)
- [x] نموذج برنامج إمداد (توفير التجهيزات)
- [x] نموذج برنامج إثراء (سداد الفواتير)
- [x] نموذج برنامج سدانة (خدمات النظافة)
- [x] نموذج برنامج طاقة (الطاقة الشمسية)
- [x] نموذج برنامج مياه (أنظمة المياه)
- [x] نموذج برنامج سقيا (توفير ماء الشرب)

## المرحلة 5: نظام تتبع الطلبات
- [x] تطبيق المراحل السبع للطلبات
- [x] مرحلة 1: تقديم الطلب
- [x] مرحلة 2: المراجعة الأولية
- [x] مرحلة 3: الزيارة الميدانية
- [x] مرحلة 4: التقييم الفني
- [x] مرحلة 5: التقييم المالي
- [x] مرحلة 6: التنفيذ
- [x] مرحلة 7: الإغلاق
- [x] نظام تحديث حالة الطلب
- [x] سجل تاريخ الطلب

## المرحلة 6: الإشعارات والتقارير ولوحة التحكم
- [ ] نظام الإشعارات الداخلية
- [ ] إشعارات البريد الإلكتروني
- [ ] لوحة تحكم المدير العام
- [ ] لوحة تحكم مكتب المشاريع
- [ ] لوحة تحكم الفريق الميداني
- [ ] لوحة تحكم طالب الخدمة
- [ ] تقارير الطلبات
- [ ] تقارير المساجد
- [ ] تقارير المستخدمين
- [ ] تقارير مالية
- [ ] رسوم بيانية وإحصائيات

## المرحلة 7: إدارة المشاريع والتبرعات
- [ ] إنشاء مشروع من طلب معتمد
- [ ] إدارة مراحل المشروع
- [ ] جداول الكميات
- [ ] عروض الأسعار
- [ ] العقود
- [ ] الدفعات المالية
- [ ] فرص التبرع
- [ ] ربط المتبرعين بالمشاريع

## المرحلة 8: واجهات المستخدم
- [x] الصفحة الرئيسية العامة
- [x] صفحة تسجيل الدخول
- [x] صفحة التسجيل لطالبي الخدمة
- [x] لوحة تحكم المدير العام
- [x] لوحة تحكم مدير النظام
- [x] لوحة تحكم مكتب المشاريع
- [x] لوحة تحكم الفريق الميداني
- [x] لوحة تحكم فريق الاستجابة السريعة
- [x] لوحة تحكم الإدارة المالية
- [x] لوحة تحكم مدير المشروع
- [x] لوحة تحكم الاتصال المؤسسي
- [x] لوحة تحكم طالب الخدمة

## المرحلة 9: الهوية البصرية ومركز الشركاء
- [ ] إعدادات الهوية البصرية
- [ ] إدارة الشعارات
- [ ] إدارة الألوان
- [ ] مركز الشركاء والداعمين
- [ ] عرض الشركاء في الصفحة الرئيسية

## المرحلة 10: الاختبار
- [x] اختبارات الوحدات (Vitest)
- [x] اختبار رحلة طالب الخدمة الكاملة
- [x] اختبار رحلة الموظف
- [x] اختبار نظام الصلاحيات
- [ ] اختبار نظام الإشعارات

## المرحلة 11: النشر والتسليم
- [x] حفظ نقطة checkpoint
- [x] توثيق النظام
- [x] تسليم المشروع للمستخدم

## المرحلة 12: تحسينات إضافية

### تكامل خرائط Google الكامل
- [x] إنشاء مكون خريطة لعرض المساجد
- [x] إضافة خريطة تفاعلية في صفحة المساجد
- [x] إضافة اختيار الموقع على الخريطة في نموذج تسجيل المسجد
- [x] عرض تفاصيل المسجد على الخريطة مع نافذة معلومات
### نظام الإشعارات
- [x] إنشاء router للإشعارات
- [x] إرسال إشعار عند تقديم طلب جديد
- [x] إرسال إشعار عند تغيير حالة الطلب
- [x] إرسال إشعار عند إضافة تعليق
- [x] إرسال إشعار عند جدولة زيارة ميدانية
- [x] صفحة عرض### البيانات التجريبية
- [x] إنشاء script لإضافة بيانات تجريبية
- [x] إضافة 10 مساجد تجريبية مع إحداثيات حقيقية
- [x] إضافة 5 شركاء تجريبيين
- [x] إضافة إعدادات الهوية البصرية
- [x] إضافة 18 مدينة في منطقة عسير
## المرحلة 13: إعداد حساب المدير
- [x] إنشاء حساب مدير النظام الافتراضي
- [x] إصلاح نظام التحقق من كلمة المرور عند تسجيل الدخول
- [x] إضافة خيار الدخول عبر Manus OAuth في صفحة تسجيل الدخول
- [x] تطبيق خط Cairo بجميع أوزانه على التصميم

## المرحلة 14: تحسين نموذج الطلبات
- [x] إنشاء نموذج طلب واحد ديناميكي (طلبات المساجد) بدلاً من 9 نماذج منفصلة
- [x] تحديث الصفحة الرئيسية لعرض "خدمات المساجد" مع زر واحد "تقدم بطلبك الآن"
- [x] تطبيق الحقول المشتركة والحقول الخاصة بكل برنامج حسب جدول نماذج الإدخال
- [ ] إضافة التنبيهات والشروط والأحكام في النموذج
- [ ] جعل بيانات مقدم الطلب تظهر تلقائياً من بيانات التسجيل


## إصلاح الأخطاء
- [x] إصلاح رسالة "المسجد غير موجود" عند تقديم طلب بنيان (لا يتطلب مسجد)
- [x] إصلاح خطأ 404 عند التوجيه بعد إرسال الطلب (/requester/requests/1)


## المرحلة 15: رفع المرفقات ولوحة طالب الخدمة وإدارة المشاريع

### رفع المرفقات
- [x] إنشاء API لرفع الملفات إلى S3
- [x] إضافة مكون رفع الملفات في نموذج الطلب
- [x] دعم رفع صور الموقع
- [x] دعم رفع صكوك الأرض والمستندات
- [x] عرض المرفقات في صفحة تفاصيل الطلب
- [x] إمكانية تحميل المرفقات

### لوحة تحكم طالب الخدمة
- [x] صفحة متابعة الطلبات الخاصة بالمستخدم
- [x] عرض حالة كل طلب مع المرحلة الحالية
- [ ] إشعارات التحديثات على الطلبات
- [ ] إمكانية إضافة تعليقات على الطلب
- [ ] عرض سجل الطلب الكامل

### نظا### نظام إدارة المشاريع
- [x] إنشاء مشروع من طلب معتمد
- [x] إدارة جداول الكميات (BOQ)
- [x] إدارة عروض الأسعار
- [x] إدارة العقود
- [x] إدارة الدفعات المالية
- [x] متابعة مراحل المشروعبط فرص التبرع بالمشاريع


## المرحلة 16: نظام العقود المتكامل

### إعدادات الجمعية (البيانات الثابتة)
- [x] جدول إعدادات الجمعية في قاعدة البيانات
- [x] صفحة إعدادات الجمعية (اسم الجمعية، رقم الترخيص، العنوان، مفوض التوقيع)
- [x] حفظ بيانات الطرف الأول (الجمعية) الثابتة

### نموذج العقد
- [x] جدول العقود في قاعدة البيانات
- [x] ترقيم آلي للعقود
- [x] نموذج إنشاء عقد جديد مع المتغيرات
- [x] أنواع العقود (إشراف هندسي، مقاولات، توريد)
- [x] جدول الدفعات المرتبط بالعقد

### معاينة وطباعة العقد
- [x] صفحة معاينة العقد قبل الطباعة
- [x] تصميم العقد بتنسيق احترافي
- [x] إمكانية طباعة العقد أو تصديره PDF

### تحويل العقد إلى مشروع
- [x] خاصية تحويل العقد المعتمد إلى مشروع
- [x] ربط العقد بالمشروع والطلب


## المرحلة 17: نظام الموردين المعتمدين

### قاعدة بيانات الموردين
- [x] تحديث جدول الموردين بالحقول الجديدة (معلومات الكيان، التواصل، البنك، المرفقات)
- [x] إضافة جدول مجالات العمل للموردين
- [x] إضافة جدول مرفقات الموردين

### نموذج تسجيل الموردين
- [x] الخطوة 1: معلومات الكيان (الاسم، النوع، السجل، النشاط، الخبرة، المجالات)
- [x] الخطوة 2: معلومات التواصل (العنوان، الموقع، البريد، الهاتف، مسؤول التواصل)
- [x] الخطوة 3: معلومات الحساب البنكي (اسم الحساب، البنك، الآيبان، الرقم الضريبي)
- [x] الخطوة 4: المرفقات (السجل التجاري، شهادة الضريبة، العنوان الوطني)

### إدارة واعتماد الموردين
- [x] صفحة قائمة الموردين مع التصفية والبحث
- [x] صفحة تفاصيل المورد
- [x] خاصية اعتماد/رفض المورد
- [x] عرض المرفقات والتحقق منها

### تكامل العقود مع الموردين
- [x] اختيار المورد المعتمد عند إنشاء العقد
- [x] تعبئة بيانات الطرف الثاني تلقائياً من بيانات المورد


## المرحلة 18: إكمال رحلة الطلب

### تحسين نموذج طلب الخدمة
- [ ] جعل بيانات مقدم الطلب تظهر تلقائياً من بيانات التسجيل (غير قابلة للتعديل)
- [ ] إضافة التنبيهات والشروط والأحكام في بداية النموذج
- [ ] تحسين عرض البيانات في صفحة المراجعة

### نموذج المعاينة الميدانية

- [x] إنشاء نموذج المعاينة الميدانية الجديد
- [x] استيراد بيانات الطلب والمسجد تلقائياً
- [x] حقول التقييم الفني (حالة المسجد، المساحات)
- [x] حقول مصلى الرجال (الطول، العرض، الارتفاع)
- [x] حقول مصلى النساء (الطول، العرض، الارتفاع)
- [x] حقل الاحتياج والوصف العام
- [x] رفع صور المعاينة (متعددة)
- [x] حقول فريق المعاينة (5 أعضاء)
### تقرير الاستجابة السريعة
- [x] إنشاء تقرير الاستجابة السريعة الجديد
- [x] استيراد بيانات الطلب والمسجد تلقائياً
- [x] حقول التقييم الفني والنهائي
- [x] حقل الأعمال غير المنفذة وأسباب عدم التنفيذ
- [x] رفع صور التوثيق (حتى 10 صور)
- [x] حقل الفني المختص

### ربط المراحل بالنماذج
- [x] ربط مرحلة الزيارة الميدانية بنموذج المعاينة
- [x] ربط مرحلة الاستجابة السريعة بتقرير الاستجابة
- [x] تحديث صفحة تفاصيل الطلب لعرض التقارير المرتبطة


## المرحلة 19: توحيد أسماء المراحل وإصلاح رحلة الطلب

### توحيد أسماء المراحل
- [x] توحيد أسماء المراحل بين Frontend و Backend
- [x] تحديث STAGE_LABELS في shared/constants.ts
- [x] تحديث stageSteps في RequestDetails.tsx
- [x] تحديث stageSteps في MyRequests.tsx
- [x] المراحل الموحدة: submitted, initial_review, field_visit, technical_eval, financial_eval, execution, closed

### اختبار رحلة الطلب
- [x] اختبار تحويل الطلب من مرحلة تقديم الطلب إلى الفرز الأولي
- [x] اختبار تحويل الطلب من مرحلة الفرز الأولي إلى الزيارة الميدانية
- [x] التأكد من عمل شريط المراحل بشكل صحيح
- [x] التأكد من تسجيل التحديثات في سجل الطلب


## المرحلة 20: نظام صلاحيات المراحل

### تحديد صلاحيات كل مرحلة
- [x] تقديم الطلب (submitted) → الفرز الأولي: مكتب المشاريع، المدير العام، مدير النظام
- [x] الفرز الأولي (initial_review) → الزيارة الميدانية: مكتب المشاريع، المدير العام، مدير النظام
- [x] الزيارة الميدانية (field_visit) → الدراسة الفنية: الفريق الميداني، مكتب المشاريع، المدير العام، مدير النظام
- [x] الدراسة الفنية (technical_eval) → الاعتماد المالي: مكتب المشاريع، المدير العام، مدير النظام
- [x] الاعتماد المالي (financial_eval) → التنفيذ: الإدارة المالية، المدير العام، مدير النظام
- [x] التنفيذ (execution) → الإغلاق: مكتب المشاريع، المدير العام، مدير النظام

### تحديث Backend
- [x] إنشاء ثوابت صلاحيات المراحل في shared/constants.ts
- [x] تحديث updateStage في requests router للتحقق من الصلاحيات
- [x] إرجاع رسالة خطأ واضحة عند عدم وجود صلاحية

### تحديث Frontend
- [x] إظهار/إخفاء زر تحويل المرحلة حسب صلاحية المستخدم
- [x] عرض رسالة توضيحية عند عدم وجود صلاحية
- [x] تحديث صفحة تفاصيل الطلب

### الاختبار
- [x] اختبار صلاحيات كل دور (18 اختبار)
- [x] التأكد من عمل النظام بشكل صحيح (93 اختبار إجمالي)

## المرحلة 21: تحديث رحلة الطلب الكاملة - الخيارات الأربعة للتقييم الفني

## المرحلة 22: إدارة التصنيفات وإضافة زر إضافة مورد

## المرحلة 23: إعادة تصميم نظام التصنيفات والموردين

### إعادة تصميم نظام التصنيفات العام
- [x] إنشاء router للتصنيفات
- [x] إنشاء صفحة إدارة التصنيفات العامة
- [x] واجهة جدول بسيطة بدلاً من التبويبات
- [x] إمكانية إضافة تصنيفات جديدة ديناميكياً
- [x] دعم التصنيفات المختلفة
- [x] نظام البحث والفلترة

### إعادة بناء نموذج تسجيل الموردين
- [x] الصفحة 1: معلومات الكيان
- [x] الصفحة 2: معلومات التواصل
- [x] الصفحة 3: معلومات البنك
- [x] الصفحة 4: المرفقات
- [x] نظام الاعتماد

### إنشاء صفحة إدارة التصنيفات
- [x] إنشاء صفحة CategoriesManagement.tsx
- [x] إضافة تبويب الوحدات
- [x] إضافة تبويب الفئات
- [x] إضافة تبويب البنود
- [x] إضافة عمليات CRUD لكل تصنيف
- [x] إضافة جداول لعرض التصنيفات
- [x] إضافة نماذج Dialog

### إضافة زر إضافة مورد
- [x] إضافة Dialog في SuppliersManagement.tsx
- [x] إضافة حقول النموذج
- [x] إضافة زر الإضافة

### تحديث الشريط الجانبي
- [x] إضافة رابط إدارة التصنيفات

### تحديث التوجيه
- [x] إضافة import ورابط /categories

### تحليل رحلة الطلب من الجدول المرفق
- [x] فهم المراحل الرئيسية: تسجيل الدخول، طلب الخدمة، التقييم الأولي، الدراسة الفنية، التقييم الفني، التقييم المالي، التنفيذ، الإغلاق
- [x] فهم الخيارات الأربعة في مرحلة التقييم الفني:
  1. الاعتذار عن الطلب (مع ذكر المبررات)
  2. تعليق الطلب (مع ذكر المبررات)
  3. التحويل إلى الاستجابة السريعة (زيارة + تقرير استجابة سريعة)
  4. التحويل إلى مشروع

### تحديث Backend
- [x] إضافة ثوابت الخيارات الأربعة في shared/constants.ts (TECHNICAL_EVAL_OPTIONS)
- [x] إضافة endpoint للتقييم الفني technicalEvalDecision
- [x] إضافة حقول جديدة للطلب: requestTrack, technicalEvalDecision, technicalEvalJustification

### مرحلة التقييم الفني (الخيارات الأربعة)
- [x] إضافة زر "الاعتذار عن الطلب" مع نموذج لذكر المبررات (ينتقل للإغلاق)
- [x] إضافة زر "تعليق الطلب" مع نموذج لذكر المبررات (يبقى في نفس المرحلة)
- [x] إضافة زر "التحويل إلى الاستجابة السريعة" (ينتقل للتنفيذ مباشرة)
- [x] إضافة زر "التحويل إلى مشروع" (ينتقل للتقييم المالي)

### تحديث Frontend
- [x] تحديث صفحة تفاصيل الطلب لعرض الخيارات الأربعة في مرحلة التقييم الفني
- [x] إضافة Dialog لكل خيار مع حقل المبررات
- [x] إخفاء زر "تحويل للمرحلة التالية" في مرحلة التقييم الفني

### الاختبار
- [x] إنشاء 21 اختبار للخيارات الأربعة (technical-eval.test.ts)
- [x] اختبار التحويل إلى مشروع من الواجهة
- [x] جميع الاختبارات ناجحة (114 اختبار)

### مرحلة التقييم المالي (للتطوير المستقبلي)
- [ ] إعداد جدول الكميات (BOQ) - موجود
- [ ] طلب عروض الأسعار
- [ ] استقبال العروض وترشيح المورد/الموردين
- [ ] تحديد تكلفة المشروع + نسبة الإشراف

### مرحلة التنفيذ (للتطوير المستقبلي)
- [ ] إعداد عقد المشروع
- [ ] إبرام العقد مع المورد/الموردين
- [ ] طلب صرف دفعة مالية
- [ ] متابعة التنفيذ حسب المراحل

### مرحلة الإغلاق (للتطوير المستقبلي)
- [ ] التقرير الختامي
- [ ] قياس رضا أصحاب المصلحة
- [ ] قياس رضا المستفيد
- [ ] إغلاق عمليات المشروع وصرف الدفعة الختامية


## المرحلة 22: تحسين سير العمل وتجربة المستخدم

### 1. الشروط المسبقة (Prerequisites) للانتقال بين المراحل
- [x] تعريف الشروط المسبقة لكل مرحلة في shared/constants.ts
- [x] الزيارة الميدانية → التقييم الفني: يجب وجود تقرير المعاينة الميدانية
- [x] التقييم الفني → التقييم المالي (مسار المشروع): يجب اختيار "التحويل إلى مشروع"
- [x] التقييم الفني → التنفيذ (مسار الاستجابة السريعة): يجب اختيار "التحويل إلى الاستجابة السريعة"
- [x] التنفيذ → الإغلاق (مسار الاستجابة السريعة): يجب وجود تقرير الاستجابة السريعة
- [x] التنفيذ → الإغلاق (مسار المشروع): يجب وجود عقد معتمد ودفعات مكتملة
- [x] تحديث Backend للتحقق من الشروط قبل الانتقال
- [ ] عرض رسائل توضيحية للمستخدم عند عدم استيفاء الشروط

### 2. تحسين واجهة أزرار التقييم الفني
- [x] تجميع الأزرار الأربعة في قسم واضح ومميز مع عنوان ووصف
- [x] إضافة أيقونات وألوان مميزة لكل خيار (أخضر/بنفسجي/أصفر/أحمر)
- [x] إضافة وصف مختصر لكل خيار يوضح متى يستخدم
- [x] تحسين تصميم الأزرار بشكل بطاقات تفاعلية
- [ ] تحسين تصميم Dialog التأكيد

### 3. تفعيل خطوات التقييم المالي
- [x] إضافة تبويب "التقييم المالي" في صفحة تفاصيل الطلب
- [x] واجهة إعداد جدول الكميات (BOQ) - هيكل أساسي
- [x] واجهة طلب عروض الأسعار - هيكل أساسي
- [x] ملخص التكلفة (تكلفة المواد + العمالة + نسبة الإشراف)
- [ ] ربط الواجهة ببيانات حقيقية من قاعدة البيانات

### 4. نماذج التقارير
- [x] ربط تقرير الاستجابة السريعة بمسار الاستجابة السريعة (يظهر فقط في مرحلة التنفيذ)
- [x] إضافة رسالة توضيحية لمسار الاستجابة السريعة
- [ ] إنشاء نموذج التقرير الختامي لمرحلة الإغلاق
- [ ] قياس رضا المستفيد
- [ ] قياس رضا أصحاب المصلحة

### 5. إشعارات المسارات التلقائية
- [x] إشعار فريق الاستجابة السريعة عند تحويل طلب لمسار الاستجابة السريعة
- [x] إشعار مكتب المشاريع والإدارة المالية عند تحويل طلب لمسار المشروع
- [x] إشعار طالب الخدمة عند تغيير حالة طلبه (موجود مسبقاً)



## المرحلة 23: نظام التقييم المالي المتكامل

### 1. صفحة إدارة جداول الكميات (BOQ)
- [ ] إنشاء صفحة قائمة جداول الكميات /boq
- [ ] عرض جميع جداول الكميات مع الطلب المرتبط
- [ ] إضافة/تعديل/حذف بنود جدول الكميات
- [ ] حساب الإجمالي التلقائي

### 2. صفحة إدارة الموردين
- [ ] إنشاء صفحة قائمة الموردين /suppliers
- [ ] إضافة/تعديل/حذف موردين
- [ ] تصنيف الموردين حسب التخصص
- [ ] عرض تقييم الموردين

### 3. صفحة طلب عروض الأسعار
- [ ] إنشاء صفحة طلب عروض الأسعار /quotations
- [ ] إرسال طلب عرض سعر لموردين محددين
- [ ] استقبال وتسجيل العروض المقدمة
- [ ] مقارنة العروض

### 4. صفحة الاعتماد المالي النهائي
- [ ] إنشاء صفحة الاعتماد المالي /financial-approval
- [ ] عرض السعر المرشح
- [ ] إضافة نسبة الإشراف
- [ ] حساب التكلفة النهائية
- [ ] زر الاعتماد النهائي

### 5. إضافة القوائم في الشريط الجانبي
- [ ] إضافة قائمة "التقييم المالي" في الشريط الجانبي
- [ ] روابط فرعية: جداول الكميات، الموردين، عروض الأسعار، الاعتماد المالي



## إصلاحات العقود (2026-01-05)
- [ ] إصلاح مشكلة حفظ العقود (الحقول الفارغة تُرسل كـ empty string)
- [ ] فحص وإصلاح مشكلة إبرام العقد من السجل الزمني في صفحة التقييم المالي

## المرحلة 24: إصلاح جدول الكميات وإضافة نظام التصنيفات

### 1. إصلاح خطأ الإدراج في جدول الكميات
- [ ] إصلاح خطأ حقل `category` المفقود في عملية الإدراج
- [ ] التأكد من أن جميع الحقول المطلوبة موجودة

### 2. إنشاء نظام التصنيفات
- [ ] إنشاء جدول `units` (الوحدات: متر، كيلو، عدد، إلخ)
- [ ] إنشاء جدول `itemCategories` (تصنيفات البنود: مواد، عمالة، معدات)
- [ ] إنشاء جدول `boqCategories` (تصنيفات الفئات: بناء، كهرباء، سباكة)
- [ ] إضافة صفحة إدارة التصنيفات
- [ ] ربط التصنيفات بجدول الكميات

### 3. إضافة نظام ترقيم جداول الكميات
- [ ] إضافة حقل `boqCode` (مثل BOQ-2025-001)
- [ ] إضافة حقل `boqName` (مسمى وصفي للجدول)
- [ ] إنشاء دالة لتوليد الرقم التلقائي
- [ ] تحديث صفحة BOQ لعرض الرقم والمسمى

### 4. توضيح بند السعر الاستشاري
- [ ] إضافة ملاحظة توضح أن بند السعر الموجود استرشادي فقط
- [ ] عدم إرسال هذا البند للمورد عند طلب العرض


## المرحلة 25: إدارة التصنيفات والموردين

### 1. إنشاء صفحة إدارة التصنيفات
- [ ] إنشاء صفحة Categories.tsx
- [ ] إضافة تبويبات للوحدات والفئات والبنود
- [ ] إضافة واجهة لإضافة وتعديل وحذف التصنيفات

### 2. إضافة زر إضافة مورد
- [ ] إضافة زر "إضافة مورد" في صفحة الموردين
- [ ] إضافة Dialog لإدخال بيانات المورد الجديد

### 3. إضافة الروابط في الشريط الجانبي
- [ ] إضافة رابط "التصنيفات" في القائمة الجانبية
- [ ] تنظيم القوائم بشكل منطقي


## المرحلة 23: إعادة تصميم نظام التصنيفات والموردين

### إعادة تصميم نظام التصنيفات العام
- [ ] إنشاء جدول التصنيفات العام (categories_master)
- [ ] إنشاء صفحة إدارة التصنيفات العامة
- [ ] واجهة جدول بسيطة بدلاً من التبويبات
- [ ] إمكانية إضافة تصنيفات جديدة ديناميكياً
- [ ] دعم التصنيفات المختلفة (مدن، جنسيات، مجالات عمل، وحدات، فئات، بنود)
- [ ] نظام البحث والفلترة




## المرحلة 24: إعادة بناء نموذج تسجيل الموردين في صفحة واحدة

### نموذج صفحة واحدة للموردين
- [x] قسم معلومات الكيان (اسم، نوع، سجل تجاري، نشاط، خبرة، مجالات عمل)
- [x] قسم معلومات التواصل (عنوان، خريطة Google، بريد، هاتف، مسؤول، وظيفة)
- [x] قسم معلومات البنك (حساب، بنك، IBAN، رقم ضريبي)
- [x] قسم المرفقات (سجل تجاري، شهادة ضريبية، عنوان وطني)
- [x] قسم بيانات الاعتماد (حالة، تاريخ، ملاحظات)


## المرحلة 25: تحديث صفحة إدارة الموردين

### تحديث نموذج إضافة مورد في صفحة الإدارة
- [x] تحديث Dialog إضافة مورد ليعرض ملخص الأقسام المطلوبة
- [x] إضافة قسم معلومات الكيان
- [x] إضافة قسم معلومات التواصل
- [x] إضافة قسم معلومات البنك
- [x] إضافة قسم المرفقات
- [x] ربط الزر بصفحة التسجيل الكاملة


## المرحلة 26: إصلاح خطأ عرض بيانات Base64

- [ ] إصلاح عرض بيانات Base64 في صفحة تسجيل الموردين
- [ ] إخفاء البيانات الخام وعرض اسم الملف فقط


## المرحلة 26: إصلاح خطأ عرض بيانات Base64

- [x] إصلاح عرض بيانات Base64 في صفحة تسجيل الموردين
- [x] تنظيف رسائل الخطأ من بيانات Base64 عند الإرسال
- [x] إصلاح خطأ useState المكرر في CategoriesManagement.tsx


## المرحلة 27: إصلاح خطأ تسجيل المورد

- [x] فحص سبب خطأ التسجيل في Backend (حقول المرفقات كانت varchar(500) وبيانات Base64 أطول)
- [x] تغيير نوع حقول المرفقات إلى mediumtext لتخزين بيانات Base64
- [x] تطبيق التغييرات على قاعدة البيانات


## المرحلة 28: توسيط صفحة تسجيل الدخول

- [x] توسيط صفحة تسجيل الدخول في منتصف الشاشة
- [x] إزالة الجانب الأيمن (الصورة) لتوسيط النموذج


## المرحلة 29: إصلاح خطأ إضافة بند جدول الكميات

- [x] فحص سبب خطأ الإدراج (projectId كان يستخدم requestId بشكل خاطئ)
- [x] تعديل router addBOQItem ليجلب أو ينشئ projectId تلقائياً
- [x] تعديل صفحة BOQ.tsx لإرسال requestId فقط
- [x] تعديل ProjectDetailsPage.tsx لإضافة requestId


## المرحلة 30: إعادة تصميم صفحة إدارة التصنيفات

- [ ] إعادة تصميم الصفحة لتعرض قائمة التصنيفات الرئيسية
- [ ] إضافة صفحة تفاصيل لكل تصنيف
- [ ] إضافة زر إضافة تصنيف جديد
- [ ] تنظيم العرض بشكل أفضل


## المرحلة 31: إصلاح مشكلة جدول الكميات

- [x] فحص سبب عدم ظهور البنود (getBOQ كان يبحث بـ projectId بدلاً من requestId)
- [x] تعديل getBOQ ليقبل requestId
- [x] تعديل صفحة BOQ.tsx لإرسال requestId
- [x] البنود تظهر الآن بشكل صحيح



## المرحلة 32: إصلاح منطق التقييم المالي وعروض الأسعار

- [x] إصلاح خطأ إضافة عرض السعر (projectId مفقود في الاستعلام)
- [x] ربط عروض الأسعار بجدول الكميات وإظهار البنود
- [x] إصلاح شروط التحقق من جدول الكميات في مرحلة التقييم المالي
- [x] ضبط التسلسل المنطقي: جدول كميات → عروض أسعار → اعتماد مالي
- [x] اختبار التسلسل الكامل


## المرحلة 33: تحسين نظام عروض الأسعار

- [x] إصلاح جلب الموردين لإظهار الشركات الجديدة في قائمة الاختيار (مع خيار إظهار غير المعتمدين)
- [x] تعديل نموذج عرض السعر لإظهار بنود جدول الكميات
- [x] تمكين تسعير كل بند على حدة مع حساب الإجمالي تلقائياً
- [x] تخزين تفاصيل البنود في حقل items بجدول quotations (JSON)
- [x] ربط عروض الأسعار بالتقييم المالي بشكل صحيح
- [x] اختبار التعديلات


## المرحلة 35: إضافة إمكانية إلغاء اعتماد العرض

- [x] إضافة زر "إلغاء الاعتماد" للعروض المعتمدة
- [x] إضافة زر "إعادة للمراجعة" للعروض المرفوضة
- [x] اختبار التعديلات


## المرحلة 36: نافذة اعتماد متقدمة مع تعديل المبلغ

- [x] إضافة نافذة Dialog للاعتماد مع حقل المبلغ المعتمد
- [x] إضافة حقل المبرر/الملاحظات (مثال: تم التفاوض مع المورد)
- [x] تعديل backend لحفظ المبلغ المعتمد والمبرر
- [x] إظهار رسالة تنبيه عند تعديل المبلغ عن الأصلي
- [x] اختبار التعديلات

**ملاحظة**: النظام يسمح باعتماد أكثر من عرض لنفس الطلب - يمكن تعديله لاحقاً إذا لزم الأمر


## المرحلة 37: ربط شاشات الطلبات وعروض الأسعار والاعتماد المالي

- [x] تحليل تدفق البيانات الحالي بين الشاشات الثلاث
- [x] ربط صفحة تفاصيل الطلب بعروض الأسعار (عرض العروض المقدمة للطلب)
- [x] ربط صفحة تفاصيل الطلب بالاعتماد المالي (عرض حالة الاعتماد)
- [x] ربط صفحة عروض الأسعار بتفاصيل الطلب (رابط للطلب المرتبط)
- [x] ربط صفحة الاعتماد المالي بعروض الأسعار المعتمدة
- [x] إضافة روابط تنقل سريعة بين الشاشات المترابطة
- [x] إضافة أزرار اعتماد/رفض عروض الأسعار في صفحة تفاصيل الطلب
- [x] إضافة نافذة اعتماد متقدمة مع إمكانية تعديل المبلغ
- [x] اختبار التكامل والترابط


## المرحلة 38: تحسينات التفاوض وسجل الطلب والانتقال بين المراحل

### خيار تعديل السعر للتفاوض
- [ ] إضافة نافذة تعديل السعر للتفاوض مع حقل المبررات
- [ ] عرض السعر الأصلي والسعر المعدل بشكل واضح
- [ ] حفظ سجل التفاوض والمبررات في قاعدة البيانات
- [ ] عرض تاريخ التفاوض في تفاصيل العرض

### تعريب سجل الطلب
- [ ] تعريب جميع عناوين سجل الطلب (Request History)
- [ ] تعريب أنواع الأحداث في السجل
- [ ] تعريب التواريخ والأوقات

### إصلاح الانتقال للمرحلة التالية
- [ ] إصلاح الانتقال من الاعتماد المالي إلى التعاقد/التنفيذ
- [ ] إضافة مرحلة التفاوض قبل التعاقد (اختياري)
- [ ] التأكد من تسلسل المراحل بشكل صحيح


## المرحلة 39: نظام قوالب العقود المتقدم

### 1. قاعدة البيانات
- [ ] إنشاء جدول قوالب العقود (contract_templates)
- [ ] إنشاء جدول بنود العقود (contract_clauses)
- [ ] إنشاء جدول قيم البنود في العقود (contract_clause_values)
- [ ] تحديث جدول العقود لربطه بالقوالب
- [ ] إنشاء جدول إعدادات الجمعية المحدث (المفوضين)
- [ ] تشغيل db:push

### 2. Backend APIs
- [ ] إنشاء router لقوالب العقود
- [ ] CRUD للقوالب (إنشاء، قراءة، تعديل، حذف)
- [ ] CRUD للبنود
- [ ] نسخ قالب
- [ ] جلب القوالب النشطة

### 3. صفحة إدارة قوالب العقود
- [ ] قائمة القوالب مع البحث والفلترة
- [ ] نموذج إنشاء قالب جديد
- [ ] محرر البنود (إضافة، تعديل، حذف، ترتيب)
- [ ] مكتبة البنود الجاهزة
- [ ] معاينة القالب

### 4. صفحة إنشاء العقد
- [ ] اختيار القالب من القوالب المتاحة
- [ ] تعبئة بيانات الأطراف تلقائياً
- [ ] تخصيص البنود (تعديل/إضافة/حذف)
- [ ] جدول الدفعات القابل للتخصيص
- [ ] حفظ العقد

### 5. صفحة معاينة وطباعة العقد
- [ ] عرض العقد بتنسيق احترافي
- [ ] الترويسة مع الشعارات
- [ ] بيانات الأطراف
- [ ] البنود المخصصة
- [ ] جدول الدفعات
- [ ] قسم التوقيعات
- [ ] تصدير PDF
- [ ] طباعة مباشرة

### 6. مرحلة التنفيذ
- [ ] ربط العقد بالمشروع
- [ ] إدارة الدفعات (طلب صرف، اعتماد، صرف)
- [ ] متابعة حالة الدفعات
- [ ] تقارير الدفعات

### 7. مرحلة الإغلاق
- [ ] نموذج التقرير الختامي
- [ ] قياس رضا المستفيد
- [ ] إغلاق المشروع
- [ ] أرشفة الملفات



## المرحلة 28: نظام إنشاء العقود المتقدم

### قوالب العقود
- [x] إنشاء جدول قوالب العقود (contractTemplates)
- [x] إنشاء جدول بنود العقود (contractClauses)
- [x] إنشاء جدول قيم البنود المخصصة (contractClauseValues)
- [x] API للحصول على قوالب العقود
- [x] API للحصول على بنود قالب معين

### نموذج إنشاء العقد المتقدم
- [x] خطوة اختيار القالب
- [x] خطوة اختيار الطرف الثاني (المورد)
- [x] خطوة تفاصيل العقد (الموضوع، المدة، القيمة)
- [x] خطوة جدول الدفعات (إضافة/حذف/تعديل الدفعات)
- [x] خطوة تخصيص البنود (تضمين/استبعاد/تعديل)
- [x] خطوة المراجعة النهائية

### حفظ بيانات العقد
- [x] حفظ templateId في العقد
- [x] حفظ paymentScheduleJson في العقد
- [x] حفظ clauseValuesJson في العقد
- [x] إنشاء سجلات الدفعات من جدول الدفعات
- [x] إنشاء سجلات قيم البنود المخصصة

### ربط العقود بالطلبات
- [x] إضافة رابط إنشاء عقد من الطلب (/contracts/new/request/:requestId)
- [x] زر إنشاء عقد في صفحة تفاصيل الطلب (عند وجود عرض سعر معتمد)
- [x] تعبئة بيانات المورد والقيمة تلقائياً من العرض المعتمد



## المرحلة 29: خاصية تكرار العقود (Duplicate)

### Backend
- [x] إضافة mutation لتكرار العقد (duplicate)
- [x] نسخ جميع بيانات العقد الأصلي
- [x] إضافة كلمة "نسخة" لعنوان العقد المكرر
- [x] توليد رقم عقد جديد للنسخة
- [x] نسخ جدول الدفعات
- [x] نسخ بنود العقد المخصصة

### Frontend
- [x] إضافة زر التكرار في قائمة العقود (صفحة تفاصيل المشروع)
- [x] إضافة زر التكرار في صفحة معاينة العقد
- [x] عرض رسالة نجاح والتوجيه للعقد الجديد


## المرحلة 30: إصلاح تعبئة بيانات الطلب تلقائياً في نموذج العقد

- [x] تعبئة المشروع المرتبط بالطلب تلقائياً
- [x] إخفاء قائمة اختيار المشروع عند وجود requestId وعرض المشروع كقيمة ثابتة
- [x] تعبئة بيانات المورد من عرض السعر المعتمد
- [x] تعبئة قيمة العقد من عرض السعر المعتمد


## المرحلة 31: نظام إدارة العقود الشامل

### صفحة قائمة العقود
- [x] إنشاء صفحة قائمة العقود المبرمة
- [x] إضافة فلترة حسب الحالة والنوع
- [x] إضافة بحث برقم العقد أو اسم المورد
- [x] إضافة أزرار استعراض وطباعة وتكرار لكل عقد
- [x] نقل قوالب العقود لتكون ضمن قائمة العقود (تبويبات)

### نظام اعتماد العقد
- [x] حالات العقد موجودة (مسودة، قيد الاعتماد، معتمد، ساري، مكتمل، ملغي)
- [x] زر اعتماد العقد موجود
- [x] إضافة علامة "معتمد" على العقد المعتمد

### نظام التعديل بموافقة
- [x] إنشاء جدول طلبات تعديل العقود
- [x] إنشاء جدول سجل تعديلات العقود
- [x] إضافة APIs لطلب التعديل والموافقة والرفض
- [x] منع التعديل للعقود التي صُرفت لها دفعات
- [x] العقود المعتمدة تحتاج موافقة للتعديل


## المرحلة 32: إصلاحات نظام العقود

### تقييد تواريخ الدفعات
- [x] تقييد تواريخ الدفعات لتكون ضمن فترة العقد (من تاريخ البدء حتى انتهاء المدة)
- [x] منع اختيار تاريخ خارج الإطار الزمني للعقد (مع رسالة توضيحية)

### تعبئة قيمة العقد
- [x] تعبئة قيمة العقد من المبلغ المعتمد (approvedAmount) بدلاً من المبلغ الأصلي
- [x] عرض المبلغ المعتمد بعد التفاوض

### سجل التاريخ
- [x] إضافة سجل في التاريخ عند إنشاء عقد جديد
- [x] ربط العقد بالطلب في السجل الزمني


## المرحلة 33: واجهة طلب التعديل على العقد

### نموذج طلب التعديل
- [ ] إضافة زر "طلب تعديل" في صفحة معاينة العقد
- [ ] نموذج Dialog لطلب التعديل مع:
  - [ ] حقل وصف التعديلات المطلوبة (إلزامي)
  - [ ] حقل المبررات (إلزامي)
  - [ ] اختيار نوع التعديل (بيانات أساسية، قيمة، مدة، بنود)
- [ ] التحقق من أن العقد لم تُصرف له دفعات

### عرض طلبات التعديل المعلقة
- [ ] قسم يعرض طلبات التعديل المعلقة للمسؤولين
- [ ] أزرار الموافقة والرفض مع حقل الملاحظات
- [ ] إشعار عند الموافقة أو الرفض

### سجل التعديلات
- [ ] عرض سجل جميع التعديلات السابقة على العقد
- [ ] تفاصيل كل تعديل (التاريخ، المستخدم، التغييرات، المبررات)


## المرحلة 33: واجهة طلب التعديل على العقد (مكتملة)

### نموذج طلب التعديل
- [x] زر "طلب تعديل" في صفحة معاينة العقد المعتمد
- [x] نموذج طلب التعديل مع حقول: نوع التعديل، وصف التعديلات، المبررات
- [x] حقل المبررات إلزامي
- [x] تنبيه توضيحي للمستخدم

### عرض طلبات التعديل
- [x] قسم عرض طلبات التعديل المعلقة
- [x] أزرار الموافقة والرفض
- [x] نموذج الموافقة/الرفض مع الملاحظات

### سجل التعديلات
- [x] عرض سجل التعديلات السابقة على العقد (قابل للطي)
- [x] عرض تفاصيل كل تعديل (النوع، الوصف، المبرر، التاريخ)


## المرحلة 34: إصلاحات نظام العقود والمنطق

### إصلاحات عاجلة
- [ ] إصلاح خطأ زر العودة في صفحة العقد
- [ ] إزالة زر التكرار من العقود (يبقى في القوالب فقط)
- [ ] منع اعتماد أكثر من عقد لنفس المشروع

### قيمة العقد والنسبة
- [ ] تعبئة قيمة العقد من المبلغ المعتمد شامل النسبة
- [ ] إضافة حقل النسبة قابل للتخصيص

### تحويل العقد لمشروع
- [ ] عند اعتماد العقد يتحول تلقائياً لمشروع
- [ ] ربط العقد بالمشروع الجديد

### تحسين عرض البيانات
- [ ] عرض عروض الأسعار كقائمة بدلاً من قائمة منسدلة
- [ ] عرض جداول الكميات كقائمة بدلاً من قائمة منسدلة

### بيانات الجمعية
- [ ] توضيح مكان إضافة بيانات التعاقد الخاصة بالجمعية


## المرحلة 34: إصلاحات نظام العقود الشاملة (مكتملة)

### إصلاحات الواجهة
- [x] إصلاح زر العودة في صفحة معاينة العقد (يذهب لقائمة العقود)
- [x] إزالة زر التكرار من العقود (يبقى في القوالب فقط)

### منطق العقود
- [x] منع اعتماد عقدين لنفس المشروع
- [x] تحويل العقد المعتمد لمشروع (تحديث حالة المشروع إلى "قيد التنفيذ")
- [x] إضافة سجل في تاريخ الطلب عند اعتماد العقد

### القيمة المالية
- [x] تعبئة قيمة العقد من المبلغ المعتمد شامل النسبة
- [x] إضافة حقل نسبة الإشراف/الإدارة قابل للتخصيص
- [x] حساب إجمالي القيمة تلقائياً (القيمة الأساسية + النسبة)


## المرحلة 35: تحسينات العروض وإعدادات الجمعية والعلامة المائية
### تحسين عرض العروض وجداول الكميات
- [x] تحويل عرض العروض من قائمة منسدلة إلى جدول
- [x] عرض جميع العروض مع تفاصيلها للمقارنة
- [x] تحويل عرض جداول الكميات إلى جدول
- [x] إضافة إمكانية الفلترة والبحث

### صفحة إعدادات الجمعية
- [x] إنشاء صفحة إعدادات الجمعية
- [x] حقول: اسم الجمعية، رقم الترخيص، العنوان
- [x] حقول: مفوض التوقيع، منصبه، رقم الهوية
- [x] حقول: البريد الإلكتروني، رقم الهاتف
- [x] ربط البيانات بالعقود

### علامة مائية معتمد

- [x] إضافة علامة مائية "معتمد" على العقد المعتمد عند الطباعة
- [x] تمييز العقد المعتمد عن المسودات


## المرحلة 36: تحسين نظام التفاوض وربط العقود بالمشاريع

### مراجعة النظام الحالي
- [ ] مراجعة جدول الكميات (BOQ) - كميات فقط بدون أسعار
- [ ] مراجعة عروض الأسعار - تبقى كما وردت من الموردين
- [ ] مراجعة العقد - نسبة الإشراف تضاف هنا فقط

### ميزة التفاوض مع المورد
- [ ] إضافة حقل السعر بعد التفاوض في عرض السعر
- [ ] إضافة حقل ملاحظات التفاوض
- [ ] إضافة حالة "قيد التفاوض" لعرض السعر
- [ ] واجهة لإدخال نتيجة التفاوض

### ربط السعر بعد التفاوض بالعقد
- [ ] استخدام السعر بعد التفاوض (إن وجد) في العقد
- [ ] إذا لم يكن هناك تفاوض، استخدام السعر الأصلي
- [ ] عرض الفرق بين السعر الأصلي والسعر بعد التفاوض

### تفعيل الانتقال للخطوات التالية
- [ ] التأكد من الانتقال بعد الاعتماد المالي
- [ ] التأكد من الانتقال بعد توقيع العقد
- [ ] تحويل الطلب لمشروع بعد اعتماد العقد

## المرحلة 36 (مكتملة): تحسين نظام التفاوض والعقود

### ميزة التفاوض مع المورد
- [x] إضافة حالة "قيد التفاوض" لعروض الأسعار
- [x] إضافة حقول التفاوض (negotiatedAmount, negotiationNotes, negotiatedBy, negotiatedAt)
- [x] إضافة زر "تفاوض" في صفحة عروض الأسعار
- [x] إضافة نافذة تسجيل نتيجة التفاوض
- [x] عرض المبلغ بعد التفاوض في جدول العروض
- [x] عرض نسبة الوفر بعد التفاوض

### ربط السعر بعد التفاوض بالعقد
- [x] تحديث ContractForm لاستخدام المبلغ بعد التفاوض (الأولوية: المعتمد > المتفاوض > الأصلي)

### الانتقال للخطوات التالية
- [x] اعتماد العقد يحول المشروع لمرحلة التنفيذ
- [x] تفعيل العقد يحدد تاريخ البداية والنهاية
- [x] تحويل العقد لمشروع (إذا لم يكن مرتبط)

### المنطق الصحيح للتكاليف
- [x] جداول الكميات: كميات فقط بدون أسعار
- [x] عروض الأسعار: كما وردت من الموردين (لا تُعدل)
- [x] العقد: يتضمن نسبة الإشراف المنفصلة


## المرحلة 36 (مكتملة): تحسين نظام التفاوض والعقود

### ميزة التفاوض مع المورد
- [x] إضافة حالة "قيد التفاوض" لعروض الأسعار
- [x] إضافة حقول التفاوض (negotiatedAmount, negotiationNotes, negotiatedBy, negotiatedAt)
- [x] إضافة زر "تفاوض" في صفحة عروض الأسعار
- [x] إضافة نافذة تسجيل نتيجة التفاوض
- [x] عرض المبلغ بعد التفاوض في جدول العروض
- [x] عرض نسبة الوفر بعد التفاوض

### ربط السعر بعد التفاوض بالعقد
- [x] تحديث ContractForm لاستخدام المبلغ بعد التفاوض (الأولوية: المعتمد > المتفاوض > الأصلي)

### الانتقال للخطوات التالية
- [x] اعتماد العقد يحول المشروع لمرحلة التنفيذ
- [x] تفعيل العقد يحدد تاريخ البداية والنهاية
- [x] تحويل العقد لمشروع (إذا لم يكن مرتبط)

### المنطق الصحيح للتكاليف
- [x] جداول الكميات: كميات فقط بدون أسعار
- [x] عروض الأسعار: كما وردت من الموردين (لا تُعدل)
- [x] العقد: يتضمن نسبة الإشراف المنفصلة


## المرحلة 37: إصلاح مشاكل التفاوض وإعدادات الجمعية

### إصلاح ميزة التفاوض
- [ ] التحقق من سبب عدم انعكاس نتيجة التفاوض
- [ ] إصلاح حفظ المبلغ بعد التفاوض
- [ ] توضيح آلية العمل بشكل واضح في الواجهة
- [ ] إضافة رسائل تأكيد واضحة

### إصلاح صلاحيات إعدادات الجمعية
- [ ] إصلاح مشكلة "ليس لديك صلاحية" للمدراء
- [ ] السماح للمدير العام ومدير النظام بتعديل الإعدادات

### نظام المفوضين المتعددين
- [ ] إنشاء جدول مفوضي التوقيع (signatories)
- [ ] إضافة واجهة لإدارة المفوضين (إضافة/تعديل/حذف)
- [ ] إمكانية اختيار المفوض عند إنشاء العقد
- [ ] عرض قائمة المفوضين في إعدادات الجمعية


## المرحلة 37 (مكتملة): إصلاح مشاكل التفاوض وإعدادات الجمعية

### إصلاح ميزة التفاوض
- [x] توضيح آلية التفاوض: اضغط "تفاوض" لبدء التفاوض → "تسجيل النتيجة" → "اعتماد"
- [x] إضافة رسائل نجاح واضحة عند حفظ نتيجة التفاوض
- [x] إغلاق النوافذ تلقائياً بعد الحفظ

### إصلاح صلاحيات إعدادات الجمعية
- [x] توسيع الصلاحيات لتشمل: admin, super_admin, system_admin, general_manager, projects_office
- [x] إصلاح صلاحية رفع الشعارات

### نظام المفوضين المتعددين
- [x] إنشاء جدول signatories في قاعدة البيانات
- [x] إضافة router لإدارة المفوضين (CRUD)
- [x] إضافة واجهة إدارة المفوضين في صفحة إعدادات الجمعية
- [x] إمكانية تعيين مفوض افتراضي
- [x] حقول: الاسم، المنصب، رقم الهوية، الجوال، البريد



## المرحلة 38: تحسينات نسبة الإشراف والمفوضين

### إزالة نسبة الإشراف من الاعتماد المالي
- [ ] إزالة حقل نسبة الإشراف من صفحة الاعتماد المالي
- [ ] تحديث ملخص التكلفة لعرض تكلفة المورد فقط
- [ ] إضافة ملاحظة توضح أن نسبة الإشراف تُضاف في العقد

### ملخص المقارنة
- [ ] عرض السعر الأصلي من عرض المورد
- [ ] عرض السعر بعد التفاوض (إن وجد)
- [ ] عرض نسبة الوفر المحققة

### ربط المفوضين بالعقود
- [ ] إضافة حقل signatoryId في جدول العقود
- [ ] إضافة قائمة منسدلة لاختيار المفوض في نموذج العقد
- [ ] عرض بيانات المفوض المختار في معاينة العقد



## المرحلة 38 (مكتملة): تحسينات نسبة الإشراف والمفوضين

### إزالة نسبة الإشراف من الاعتماد المالي
- [x] إزالة نسبة الإشراف من ملخص التكلفة في صفحة الاعتماد المالي
- [x] إضافة ملاحظة توضح أن نسبة الإشراف تُضاف في العقد

### ملخص المقارنة (السعر الأصلي vs بعد التفاوض)
- [x] إضافة عرض السعر الأصلي والسعر بعد التفاوض في ملخص التكلفة
- [x] إضافة نسبة الوفر المحقق من التفاوض

### ربط المفوضين بالعقود
- [x] إضافة حقل signatoryId لجدول العقود
- [x] إضافة قائمة اختيار المفوض في نموذج إنشاء العقد
- [x] تمرير signatoryId عند إنشاء العقد


## المرحلة 39: تطوير مرحلة التنفيذ (المشاريع)

### إصلاح منطق العقد
- [ ] إخفاء زر "إنشاء عقد" إذا كان هناك عقد معتمد مسبقاً
- [ ] تفعيل الانتقال للمرحلة التالية بعد اعتماد العقد

### نظام طلبات الصرف وأوامر الصرف
- [ ] إنشاء جدول طلبات الصرف (disbursement_requests)
- [ ] إنشاء جدول أوامر الصرف (disbursement_orders)
- [ ] نموذج طلب صرف دفعة (مكتب المشاريع)
- [ ] اعتماد طلب الصرف من صاحب الصلاحية
- [ ] إصدار أمر صرف (الإدارة المالية)
- [ ] اعتماد أمر الصرف من صاحب الصلاحية

### مخطط جانت لسير المشروع
- [ ] إنشاء جدول مراحل المشروع مع التواريخ
- [ ] عرض مخطط جانت تفاعلي
- [ ] تحديث نسبة الإنجاز لكل مرحلة

### تقارير الإنجاز
- [ ] إنشاء جدول تقارير الإنجاز
- [ ] نموذج إضافة تقرير إنجاز
- [ ] عرض سجل تقارير الإنجاز

### تحديث صفحة المشاريع
- [ ] عرض طلبات الصرف وأوامر الصرف
- [ ] عرض مخطط جانت
- [ ] عرض تقارير الإنجاز

## المرحلة 39 (مكتملة): تطوير مرحلة التنفيذ (المشاريع)

### إصلاح منطق العقد
- [x] إضافة دالة getByRequestId للتحقق من وجود عقد مسبق
- [x] تحديث صفحة تفاصيل الطلب لإخفاء زر "إنشاء عقد" إذا كان هناك عقد معتمد
- [x] عرض رابط للعقد الموجود بدلاً من زر الإنشاء

### نظام طلبات الصرف وأوامر الصرف
- [x] إنشاء جدول disbursementRequests لطلبات الصرف
- [x] إنشاء جدول disbursementOrders لأوامر الصرف
- [x] إنشاء router disbursements مع CRUD كامل
- [x] إنشاء صفحة DisbursementRequests لإدارة طلبات الصرف
- [x] إضافة رابط طلبات الصرف في القائمة الجانبية

### مخطط جانت
- [x] إنشاء مكون GanttChart متكامل
- [x] دعم عرض المراحل والمهام بشكل مرئي
- [x] عرض نسبة الإنجاز لكل مهمة
- [x] تمييز الحالات بألوان مختلفة

### تقارير الإنجاز
- [x] إنشاء جدول progressReports لتقارير الإنجاز
- [x] إنشاء router progressReports مع CRUD كامل
- [x] دعم حقول: العنوان، التاريخ، نسب الإنجاز، الملخص، التحديات، الخطوات القادمة

### صفحة تفاصيل المشروع
- [x] تحديث صفحة ProjectDetails لعرض جميع الميزات
- [x] إضافة تبويبات: مخطط جانت، مراحل المشروع، طلبات الصرف، تقارير الإنجاز، المستندات
- [x] عرض ملخص المشروع (الميزانية، المصروف، نسبة الإنجاز)

## المرحلة 40: تحسين نظام المشاريع وطلبات الصرف

### ربط المشاريع بالعقود المعتمدة
- [ ] المشاريع تُنشأ تلقائياً من العقود المعتمدة فقط
- [ ] إزالة زر "مشروع جديد" من صفحة المشاريع
- [ ] عرض المشاريع المرتبطة بالعقود فقط

### تحسين نموذج طلب الصرف
- [ ] عرض قائمة المشاريع (اسم ورقم المشروع)
- [ ] عند اختيار المشروع تظهر تلقائياً:
  - اسم المشروع
  - وصف الأعمال (من موضوع العقد)
  - تكلفة المشروع الفعلية
  - النسبة الإدارية
  - إجمالي قيمة المشروع
  - اسم المورد (من العقد)
  - بيانات الحساب البنكي
- [ ] الدفعة المطلوبة (يتم كتابتها)

### تحسين نموذج أمر الصرف
- [ ] إضافة أنواع الصرف: تحويل بنكي، إصدار شيك، يسدد من العهدة
- [ ] عرض معلومات المشروع:
  - اسم المشروع
  - الجهة الداعمة
  - إجمالي قيمة الدعم
  - إجمالي قيمة العقد
  - إجمالي ما تم دفعه
  - المبلغ المتبقي بعد صرف المبلغ أعلاه
- [ ] عرض بيانات التحويل البنكي:
  - اسم الحساب
  - اسم البنك
  - رقم الآيبان
  - رقم سداد
  - رمز المفوتر
- [ ] توقيعات الاعتماد: المحاسب، المدير التنفيذي



## المرحلة 41: إصلاح وتحسين النظام (الجلسة الحالية)

### إصلاح أخطاء TypeScript
- [x] إصلاح خطأ reportNumber في progressReports.ts
- [x] إصلاح خطأ overallProgress في ProjectDetails.tsx
- [x] إصلاح خطأ endDate في ProjectDetails.tsx
- [x] إصلاح خطأ ganttTasks status type في ProjectDetails.tsx

### ربط المشاريع بالعقود المعتمدة فقط
- [ ] تعديل منطق المشاريع ليتم إنشاؤها تلقائياً من العقود المعتمدة
- [ ] إزالة المشاريع التي ليست مرتبطة بعقود معتمدة

#### تحسين نموذج طلب الصرف
- [x] إضافة قائمة منسدلة للمشاريع (اسم ورقم المشروع)
- [x] التعبئة التلقائية عند اختيار المشروع:
  - اسم المشروع
  - وصف الأعمال (من موضوع العقد)
  - تكلفة المشروع الفعلية
  - إجمالي قيمة العقد
  - إجمالي ما تم دفعه
  - المبلغ المتبقي
  - اسم المورد
  - بيانات الحساب البنكي (البنك، الآيبان)
- [x] الدفعة المطلوبة فقط يتم إدخالها يدوياً
### إعادة تصميم أمر الصرف حسب القالب
- [x] إضافة ثلاثة أنواع للصرف:
  - تحويل بنكي
  - إصدار شيك
  - صرف من العهدة
- [x] تصميم نموذج أمر الصرف مع خيارات الدفع المتعددة
- [x] إضافة قسم "خاص بالمشاريع" مع البيانات المطلوبة
- [x] إضافة قسم "تحويل بنكي من حساب الجمعية إلى" مع حقول:
  - اسم الحساب
  - اسم البنك
  - رقم الآيبان
  - رقم سداد
  - رمز المفوتر
- [x] إضافة جدول التوقيعات (المحاسب، المدير التنفيذي)
- [x] إضافة دالة تحويل الأرقام إلى نص عربي (numberToArabicText)
- [x] تحسين عرض أمر الصرف ليشمل:
  - رأس أمر الصرف مع الرقم والتاريخ
  - بيانات الصرف الأساسية (المستفيد، المبلغ رقماً وكتابة)
  - قسم خاص بالمشاريع
  - قسم التحويل البنكي / الشيك / العهدة
  - جدول التوقيعات

## المرحلة 42: إصلاح خطأ إضافة المفوض
- [x] إصلاح خطأ: Failed query: update `signatories` set `isDefault` = ? params: false
  - السبب: كان يتم تحديث جميع السجلات بدون where clause
  - الحل: إضافة where(eq(signatories.isDefault, true)) لتحديد السجلات المطلوبة فقط

## المرحلة 43: إصلاح مشكلة جدول signatories
- [x] التحقق من وجود جدول signatories في قاعدة البيانات
- [x] إنشاء جدول signatories يدوياً (لم يكن موجوداً في قاعدة البيانات)

## المرحلة 44: إصلاح مشكلة مسح اسم المورد عند حفظ العقد
- [ ] تحليل سبب مسح اسم المورد عند الضغط على إنشاء العقد
- [ ] إصلاح المشكلة في نموذج إنشاء العقد


## المرحلة 26: تحسينات تجربة المستخدم UX

### إصلاح التقييم المالي - تحويله لزر إجراء ذكي
- [ ] إزالة تبويب التقييم المالي المنفصل
- [ ] إضافة شريط حالة ذكي (Smart Status Bar) في صفحة تفاصيل الطلب
- [ ] عرض المرحلة الحالية بوضوح مع زر إجراء واحد
- [ ] إضافة مؤشر تقدم بصري للمراحل

### إكمال نظام أمر الصرف
- [ ] ربط طلب الصرف بالعقد المعتمد
- [ ] إنشاء نموذج أمر الصرف من طلب الصرف المعتمد
- [ ] تتبع حالة أمر الصرف (معلق، معتمد، منفذ)
- [ ] ربط أمر الصرف بالدفعات المالية في العقد

### إضافة مخطط جانت لتتبع مراحل المشروع
- [ ] إنشاء جدول مراحل المشروع مع التواريخ
- [ ] تصميم مكون مخطط جانت التفاعلي
- [ ] عرض المراحل الرئيسية (تصميم، تنفيذ، تسليم)
- [ ] تتبع التقدم الفعلي vs المخطط
- [ ] إضافة تنبيهات التأخير

### تقارير الإنجاز للمراحل
- [ ] إنشاء جدول تقارير الإنجاز في قاعدة البيانات
- [ ] نموذج إنشاء تقرير إنجاز جديد
- [ ] حقول المعلومات الأساسية للمشروع
- [ ] حقول تفاصيل المرحلة (البدء، الانتهاء، نسبة الإنجاز)
- [ ] حقول الملاحظات والتحديات
- [ ] رفع المرفقات (صور، مستندات)
- [ ] عرض تقارير الإنجاز في صفحة المشروع



## المرحلة 26: تحسينات تجربة المستخدم (مكتملة)

### 1. إصلاح التقييم المالي - تحويله لزر إجراء ذكي
- [x] إنشاء مكون SmartStatusBar.tsx
- [x] عرض المرحلة الحالية والإجراء المطلوب
- [x] إضافة زر إجراء واحد واضح للانتقال للخطوة التالية
- [x] إضافة مؤشر تقدم بصري
- [x] دمج المكون في صفحة تفاصيل الطلب

### 2. إكمال نظام أمر الصرف المرتبط بالعقود
- [x] إضافة زر "طلب صرف" في صفحة معاينة العقد للعقود المعتمدة
- [x] ربط طلب الصرف بالعقد المعتمد

### 3. تحسين مخطط جانت لتتبع مراحل المشروع
- [x] إضافة حقول التواريخ الفعلية (actualStartDate, actualEndDate)
- [x] إضافة حقل الوصف للمهام
- [x] إضافة دالة حساب التأخير بالأيام
- [x] عرض تنبيهات التأخير في التلميحات
- [x] عرض التواريخ المخططة والفعلية بشكل منفصل

### 4. إنشاء نظام تقارير الإنجاز للمراحل
- [x] إنشاء صفحة ProgressReports.tsx
- [x] إضافة نموذج إنشاء تقرير جديد
- [x] عرض قائمة التقارير مع التصفية والبحث
- [x] عرض تفاصيل التقرير
- [x] حساب الانحراف (متقدم/متأخر/حسب الخطة)
- [x] إضافة إحصائيات التقارير
- [x] إضافة رابط في القائمة الجانبية
- [x] إضافة المسار في App.tsx

### 5. الاختبارات
- [x] كتابة اختبارات لتقارير الإنجاز (15 اختبار)
- [x] جميع الاختبارات ناجحة (129 اختبار إجمالي)


## المرحلة 27: إصلاح وتفعيل مرحلة التنفيذ

### 1. إصلاح شاشة المشاريع وربطها بالعقود
- [ ] عرض العقود المرتبطة بكل مشروع في شاشة المشاريع
- [ ] إزالة المشاريع غير المرتبطة بعقود أو ربطها
- [ ] إضافة رابط للعقد من صفحة المشروع
- [ ] عرض حالة العقد في قائمة المشاريع

### 2. تفعيل مخطط جانت في صفحة المشروع
- [ ] إضافة مخطط جانت في صفحة تفاصيل المشروع
- [ ] عرض مراحل المشروع مع التواريخ
- [ ] إضافة إمكانية تحديث التواريخ الفعلية
- [ ] عرض تنبيهات التأخير

### 3. ربط تقارير الإنجاز بالمشاريع
- [ ] إضافة قسم تقارير الإنجاز في صفحة المشروع
- [ ] إمكانية إنشاء تقرير إنجاز من صفحة المشروع
- [ ] عرض سجل تقارير الإنجاز للمشروع

### 4. إكمال نظام طلبات الصرف وأوامر الصرف
- [ ] إنشاء طلب صرف من العقد المعتمد
- [ ] مراجعة واعتماد طلب الصرف
- [ ] تحويل طلب الصرف إلى أمر صرف
- [ ] تتبع حالة أمر الصرف
- [ ] ربط الدفعات بالعقد والمشروع

### 5. اختبار رحلة التنفيذ الكاملة
- [ ] اختبار إنشاء طلب صرف من عقد
- [ ] اختبار تحويل طلب الصرف لأمر صرف
- [ ] اختبار تحديث مراحل المشروع
- [ ] اختبار إنشاء تقرير إنجاز


## المرحلة 28: إعادة بناء البيانات التجريبية من الصفر

- [x] حذف جميع البيانات المدخلة (طلبات، مشاريع، عقود، جداول كميات، طلبات صرف، أوامر صرف)
- [x] الحفاظ على المستخدمين وقوالب العقود والإعدادات
- [x] إنشاء بيانات مساجد تجريبية (5 مساجد)
- [x] إنشاء بيانات موردين معتمدين (3 موردين)
- [x] إنشاء طالبي خدمة (3 طالبين)
- [x] إنشاء طلبات في مراحل مختلفة:
  - طلب جديد (submitted)
  - طلب في المعاينة (field_visit)
  - طلب في التقييم الفني (technical_eval)
  - طلب في التقييم المالي (financial_eval)
  - طلب في التنفيذ (execution)
- [x] إنشاء مشاريع مرتبطة بالطلبات
- [x] إنشاء عقود مرتبطة بالمشاريع
- [x] إنشاء جداول كميات
- [x] إنشاء طلبات صرف وأوامر صرف
- [x] اختبار الرحلة الكاملة والتأكد من التسلسل


## المرحلة 29: إعادة بناء نظام طلبات الصرف وأوامر الصرف

### 1. توسيع نظام التصنيفات
- [ ] إضافة تصنيف "مصادر الدعم" (متجر تبرعات، إحسان، جهة مانحة، متبرع، إسناد، دعم الجمعية، أخرى)
- [ ] إضافة تصنيف "الجهات المالكة للمشاريع" (مكتب المشاريع، الاتصال المؤسسي، ...)
- [ ] إضافة تصنيف "أصحاب صلاحية التوقيع" (المدير التنفيذي، المدير المالي، المحاسب، ...)
- [ ] تحديث صفحة إدارة التصنيفات لعرض التصنيفات الجديدة

### 2. نظام مصادر الدعم للمشاريع
- [ ] إنشاء جدول project_funding_sources في قاعدة البيانات
- [ ] إنشاء router لمصادر الدعم
- [ ] إضافة واجهة إدارة مصادر الدعم في صفحة المشروع
- [ ] تتبع المبلغ المصروف من كل مصدر دعم
- [ ] التحقق من عدم تجاوز مبلغ الدعم المخصص

### 3. نظام طلب الصرف المستقل
- [ ] تحديث جدول طلبات الصرف بالحقول الجديدة:
  - رقم التسلسل (آلي)
  - التاريخ الهجري والميلادي
  - الجهة المالكة للمشروع
  - مصدر الدعم
  - اسم الجهة الداعمة
  - مبلغ الدعم
  - وصف الأعمال المطلوبة
  - تكلفة المشروع الفعلية
  - الأجور الإدارية
  - بيانات المورد (الاسم، الأعمال، المبلغ، الآيبان)
- [ ] إنشاء صفحة إنشاء طلب صرف جديد
- [ ] إنشاء صفحة عرض تفاصيل طلب الصرف
- [ ] إضافة سير عمل الاعتماد (مدير المشروع → المدير التنفيذي)
- [ ] إنشاء صفحة طباعة طلب الصرف (PDF)

### 4. نظام أمر الصرف المستقل
- [ ] تحديث جدول أوامر الصرف بالحقول الجديدة:
  - رقم الأمر (آلي)
  - التاريخ الهجري والميلادي
  - رقم طلب الصرف المرتبط
  - المبلغ رقماً وكتابة
  - الغرض من الصرف
  - بيانات المشروع (الاسم، الجهة الداعمة، قيمة الدعم، قيمة العقد، ما تم دفعه، المتبقي)
  - بيانات التحويل البنكي (اسم الحساب، البنك، الآيبان، سداد، رمز المفوتر)
- [ ] إنشاء صفحة إنشاء أمر صرف من طلب صرف معتمد
- [ ] إنشاء صفحة عرض تفاصيل أمر الصرف
- [ ] إضافة سير عمل الاعتماد (المحاسب → المدير المالي → صاحب الصلاحية)
- [ ] إنشاء صفحة طباعة أمر الصرف (PDF)

### 5. التقارير والإحصائيات
- [ ] تقرير مصادر الدعم لكل مشروع
- [ ] تقرير الصرف لكل جهة داعمة
- [ ] تنبيه عند اقتراب استنفاد مبلغ الدعم


## المرحلة 33: نظام طلبات الصرف وأوامر الصرف المحسن

### نظام التصنيفات الموسع
- [x] إضافة أنواع تصنيفات جديدة (مصادر الدعم، الجهات المالكة)
- [x] إنشاء صفحة إدارة التصنيفات الشاملة
- [x] دعم التصنيفات متعددة المستويات

### نظام طلب الصرف المستقل
- [x] إنشاء جدول طلبات الصرف المحسن
- [x] ربط طلب الصرف بالمشروع والعقد
- [x] إضافة حقول مصدر الدعم والتكاليف
- [x] إنشاء صفحة طلب صرف جديد
- [x] إنشاء صفحة قائمة طلبات الصرف
- [x] نظام اعتماد/رفض طلبات الصرف

### نظام أمر الصرف المستقل
- [x] إنشاء جدول أوامر الصرف
- [x] ربط أمر الصرف بطلب الصرف
- [x] إضافة طرق الدفع المتعددة (تحويل بنكي، شيك، عهدة، سداد)
- [x] إنشاء صفحة أمر صرف جديد
- [x] إنشاء صفحة قائمة أوامر الصرف
- [x] نظام اعتماد/تنفيذ أوامر الصرف

### صفحات الطباعة الاحترافية
- [x] صفحة طباعة طلب الصرف (حسب نموذج PMO)
- [x] صفحة طباعة أمر الصرف (حسب نموذج منارة)
- [x] تحويل الأرقام إلى نص عربي
- [x] تحويل التاريخ الميلادي إلى هجري
- [x] تصميم متوافق مع الطباعة

### الاختبارات
- [x] اختبارات إنشاء طلب الصرف
- [x] اختبارات تحديث حالة طلب الصرف
- [x] اختبارات إنشاء أمر الصرف
- [x] اختبارات تحديث حالة أمر الصرف
- [x] اختبارات تنفيذ أمر الصرف
- [x] اختبارات الربط بين الطلبات والأوامر


## إصلاحات عاجلة - نظام الصرف

### أخطاء مكتشفة
- [x] خطأ في استعلام قاعدة البيانات عند إنشاء أمر الصرف (الأعمدة غير متطابقة)
- [x] إضافة رابط منفصل لأوامر الصرف في القائمة الجانبية
- [x] إنشاء صفحة أوامر الصرف المنفصلة


## المرحلة 34: التقارير المالية والإشعارات

### اختبار نظام الصرف
- [x] اختبار إنشاء أمر صرف من طلب صرف معتمد
- [x] التأكد من عمل النظام بشكل كامل

### التقرير المالي الشامل
- [x] إنشاء صفحة التقرير المالي الشامل
- [x] عرض إجمالي المصروفات حسب المشروع
- [x] عرض إجمالي المصروفات حسب نوع الدفعة
- [x] عرض ملخص أوامر الصرف حسب الحالة
- [x] عرض المصروفات حسب الشهر

### الإشعارات التلقائية
- [x] إشعار للإدارة المالية عند اعتماد طلب صرف جديد
- [x] إشعار للمدير العام عند إنشاء أمر صرف جديد
- [x] إشعار للإدارة المالية عند اعتماد أمر الصرف للتنفيذ
- [ ] إشعار عند تنفيذ أمر الصرف


## إصلاحات عاجلة - معاينة أمر الصرف

- [x] إصلاح خطأ 404 في صفحة معاينة أمر الصرف `/disbursement-orders/:id`
- [x] إنشاء صفحة تفاصيل أمر الصرف


## تحسينات صفحات الطباعة

### أمر الصرف
- [x] تصغير الخطوط والتصميم ليظهر في صفحة واحدة
- [x] إبراز المبلغ المطلوب دفعه بطريقة جميلة وواضحة

### طلب الصرف
- [x] تصغير الخطوط والتصميم ليظهر في صفحة واحدة
- [x] إبراز المبلغ المطلوب بطريقة جميلة وواضحة


## تعديلات صفحات الطباعة - موازنة التنسيق

- [x] زيادة حجم الخطوط لتكون مقروءة
- [x] تصغير إبراز المبلغ ليكون مناسباً
- [x] ضمان الطباعة على صفحة A4 واحدة


## ربط شعار الجمعية بالهوية البصرية

- [ ] فحص مشكلات ملف الشعار في الهوية البصرية
- [ ] ربط شعار الجمعية في صفحات الطباعة بإعدادات الهوية
- [ ] التأكد من تحديث الشعار تلقائياً عند تغييره في الهوية


## تحسينات الهوية البصرية وصفحات الطباعة والصرف

### الهوية البصرية
- [x] إصلاح رفع الشعارات في صفحة الهوية البصرية

### صفحات الطباعة
- [x] وضع الشعار على اليمين في صفحة طباعة أمر الصرف
- [x] وضع الشعار على اليمين في صفحة طباعة طلب الصرف

### صفحة طلبات الصرف
- [x] إزالة تبويب أوامر الصرف من صفحة طلبات الصرف
- [x] تعديل العنوان من "طلبات الصرف وأوامر الصرف" إلى "طلبات الصرف"


## تفريغ البيانات التجريبية

- [x] حذف جميع البيانات التجريبية من قاعدة البيانات
- [x] التأكد من تفريغ جميع الجداول


## إضافة حقول المسؤولين لبيانات المنظمة

### الحقول الجديدة
- [ ] جهة الإشراف الإداري
- [ ] جهة الإشراف الفني
- [ ] اسم رئيس مجلس الإدارة
- [ ] اسم المدير التنفيذي
- [ ] اسم المحاسب

### التحديثات المطلوبة
- [ ] إضافة الحقول إلى schema قاعدة البيانات
- [ ] تحديث صفحة إعدادات المنظمة
- [ ] استخدام الحقول في صفحة طباعة أمر الصرف


## نظام تسجيل الدخول المحلي

### المتطلبات
- [ ] تفعيل تسجيل الدخول باسم المستخدم وكلمة المرور
- [ ] إضافة صفحة تسجيل حساب جديد لطالبي الخدمة
- [ ] إضافة خاصية إعادة تعيين كلمة المرور في إدارة المستخدمين
- [ ] تعيين كلمة مرور لمدير النظام admin@tamam.sa


## المرحلة 40: نظام إعادة تعيين كلمة المرور

### إعادة تعيين كلمة المرور للمدراء
- [x] إنشاء endpoint resetUserPassword في auth router
- [x] إضافة زر إعادة تعيين كلمة المرور في صفحة إدارة المستخدمين
- [x] إنشاء نافذة إعادة تعيين كلمة المرور مع توليد كلمة مرور عشوائية
- [x] تسجيل عملية إعادة التعيين في سجل التدقيق

### تعيين كلمة مرور للمستخدمين
- [x] إنشاء endpoint setPassword للمستخدمين الذين سجلوا عبر OAuth
- [ ] إضافة صفحة تعيين كلمة المرور للمستخدمين الجدد



## المرحلة 41: تعديل نظام المصادقة

### إيقاف الدخول عبر Manus OAuth
- [x] إزالة زر الدخول عبر Manus من صفحة تسجيل الدخول
- [x] إزالة زر التسجيل عبر Manus من صفحة تسجيل طالبي الخدمة (لم يكن موجوداً)
- [x] تفعيل الدخول باسم المستخدم وكلمة المرور فقط
- [x] تحديث دالة authenticateRequest لدعم JWT المحلي
- [x] اختبار الدخول بحساب admin@tamam.sa بنجاح



## المرحلة 42: إصلاح خطأ عرض بيانات المستخدم

### المشكلة
- [x] المستخدم aboody_059@hotmail.com كان يعرض بيانات مستخدم آخر (محمد أحمد - mohammed@example.com)
- [x] فحص صفحة تفاصيل المستخدم
- [x] فحص قاعدة البيانات
- [x] إضافة getUserById لجلب بيانات مستخدم
- [x] تحديث UserDetails لاستخدام البيانات الفعلية


## المرحلة 43: إصلاح خطأ NaN في الإحداثيات الجغرافية

### المشكلة
- [x] خطأ عند تسجيل مسجد جديد
- [x] فحص صفحة LocationPicker
- [x] إضافة فحوصات NaN
- [x] إصلاح معالجة الإحداثيات
- [x] اختبار الإصلاح


## المرحلة 44: إصلاح مشكلة الملاحة في لوحة التحكم

### المشكلة
- [x] طالب الخدمة يضغط على زر لوحة التحكم ويتم توجيهه بشكل صحيح
- [x] إضافة توجيه تلقائي لطالب الخدمة
- [x] اختبار التوجيه
- [x] جميع الاختبارات ناجحة
- [x] التوجيه يعمل بشكل صحيح


## المرحلة 45: تحسين نظام تسجيل المساجد

### المتطلبات
- [ ] إضافة حقل "صفة مقدم الطلب" في نموذج التسجيل (إمام، مؤذن، متبرع، أخرى)
- [ ] إذا اختار "أخرى" → يظهر حقل نصي لإدخال الصفة
- [ ] إذا اختار "إمام" أو "مؤذن" → يظهر حقل لرفع مرفق يثبت الصفة
- [ ] تحديث نموذج تسجيل المسجد لعرض بيانات مقدم الطلب (الاسم، الصفة، الجوال، البريد)
- [ ] إزالة حقول الإمام والمؤذن من نموذج المسجد
- [ ] إضافة نظام موافقة طلبات المساجد
- [ ] منع الشخص من تقديم أكثر من طلب مسجد واحد
- [ ] اختبار النظام الجديد


## المرحلة 46: نظام الاستثناءات لطلبات المساجد

### قاعدة البيانات
- [x] إضافة حقل mosqueExemptions في جدول المستخدمين

### Backend
- [x] إضافة endpoint لمنح استثناء لمستخدم
- [x] إضافة endpoint لإلغاء استثناء
- [x] تسجيل عمليات الاستثناء في سجل التدقيق

### Frontend
- [x] إضافة زر "منح استثناء" في صفحة تفاصيل المستخدم
- [x] إضافة Dialog لتأكيد منح الاستثناء
- [x] عرض عدد الاستثناءات المتبقية للمستخدم

### تحديث نموذج المسجد
- [x] التحقق من عدد الاستثناءات المتبقية قبل السماح بالتسجيل
- [x] عرض رسالة توضيحية عند استخدام استثناء


## المرحلة 47: إصلاح نموذج التسجيل ومحاذاة نموذج المسجد

### نموذج التسجيل (Register)
- [ ] إضافة قائمة صفة مقدم الطلب (إمام، مؤذن، متبرع)
- [ ] إظهار حقل رفع مرفق إثبات الصفة عند اختيار إمام أو مؤذن
- [ ] التحقق من رفع المرفق قبل إرسال النموذج

### نموذج تسجيل المسجد (MosqueForm)
- [ ] إصلاح محاذاة النموذج للوسط بدلاً من اليمين


## المرحلة 48: إصلاحات واجهة المستخدم

### نموذج التسجيل
- [x] إصلاح محاذاة النموذج للوسط

### شاشة طالبي الخدمة
- [x] إخفاء زر لوحة التحكم من القائمة الجانبية لطالبي الخدمة

## المرحلة 49: تحديث نموذج تسجيل المسجد

### الحقول المطلوبة
- [ ] إضافة حقل مساحة المسجد
- [ ] إضافة حقل عدد المصلين
- [ ] إضافة حقل هل يوجد مصلى
- [ ] إضافة حقل المدينة/المحافظة/المركز
- [ ] إضافة حقل عمر المسجد

### الحقول المحذوفة
- [ ] حذف حقل حالة المسجد
- [ ] حذف حقل نوع الملكية


## المرحلة 49: تحديث نموذج تسجيل المسجد (2026-01-06)

### الحقول المضافة
- [x] إضافة حقل مساحة المسجد (area)
- [x] إضافة حقل عدد المصلين (capacity)
- [x] إضافة حقل هل يوجد مصلى نساء (hasPrayerHall)
- [x] إضافة حقل المحافظة (governorate)
- [x] إضافة حقل المركز (center)
- [x] إضافة حقل عمر المسجد (mosqueAge)

### الحقول المحذوفة
- [x] حذف حقل حالة المسجد (status)
- [x] حذف حقل نوع الملكية (ownership)

### التحديثات
- [x] تحديث schema قاعدة البيانات
- [x] تحديث mosques router
- [x] تحديث نموذج MosqueForm.tsx
- [x] تحديث صفحة MosquesMap.tsx
- [x] تحديث صفحة Mosques.tsx
- [x] تحديث صفحة MosqueDetails.tsx


### تحسينات إضافية
- [x] تغيير حقل المدينة إلى قائمة منسدلة بمدن منطقة عسير (47 موقع)
- [x] عرض معلومات الخريطة: الإحداثيات، خط الطول، دائرة العرض، العنوان


## المرحلة 50: إصلاح خطأ إدراج المسجد (2026-01-06)
- [ ] إصلاح خطأ insert into mosques - عدم تطابق الأعمدة والقيم


## المرحلة 50: إصلاح خطأ إدراج المسجد (2026-01-06)
- [x] إصلاح خطأ insert into mosques - عدم تطابق الأعمدة والقيم
- [x] إضافة الأعمدة الجديدة (governorate, center, hasPrayerHall, mosqueAge) لقاعدة البيانات
- [x] إصلاح مسار التوجيه بعد حفظ المسجد (/mosques بدلاً من /requester/mosques)


## المرحلة 51: إصلاح فلترة المساجد في نموذج الطلب (2026-01-07)
- [x] تعديل استعلام المساجد ليعرض فقط المساجد المسجلة بواسطة المستخدم الحالي
- [x] التأكد من أن طالب الخدمة يرى فقط مساجده


## المرحلة 52: إضافة زر اعتماد المساجد الجديدة (2026-01-07)
- [x] إضافة زر اعتماد/رفض المساجد في صفحة إدارة المساجد
- [x] عرض المساجد قيد الانتظار بشكل واضح لمدير النظام
- [x] إضافة بطاقة إحصائيات المساجد قيد المراجعة
- [x] إضافة فلتر حسب حالة الاعتماد
- [x] إضافة نافذة سبب الرفض


## المرحلة 53: تعديل صفحة تتبع الطلب لطالب الخدمة (2026-01-07)
- [ ] إخفاء تفاصيل الإجراءات الداخلية (الزيارة الميدانية، التقرير، عروض الأسعار، إلخ)
- [ ] عرض نسبة التقدم المئوية فقط لطالب الخدمة
- [ ] الحفاظ على التفاصيل الكاملة لمدير النظام والموظفين


## المرحلة 53: تعديل صفحة تتبع الطلب لطالب الخدمة (2026-01-07)
- [x] إخفاء تفاصيل الإجراءات الداخلية لطالب الخدمة
- [x] عرض نسبة التقدم المئوية فقط بدلاً من شريط المراحل التفصيلي
- [x] إخفاء سجل الطلب والتقييم المالي والتقارير لطالب الخدمة
- [x] إخفاء بطاقة الإجراءات بالكامل لطالب الخدمة
- [x] تحديث Backend لحساب نسبة التقدم تلقائياً


## المرحلة 54: إنشاء صفحة مساجدي لطالب الخدمة (2026-01-07)
- [x] إنشاء صفحة MyMosques.tsx على المسار /my-mosques
- [x] إضافة المسار في App.tsx


## المرحلة 55: إصلاح ثغرة أمنية وإعادة تصميم لوحة تحكم طالب الخدمة (2026-01-07)

### الثغرة الأمنية
- [ ] منع طالب الخدمة من الوصول لصفحة عروض الأسعار
- [ ] منع طالب الخدمة من الوصول للصفحات الإدارية
- [ ] إضافة حماية على مستوى Backend للـ procedures الإدارية

### إعادة تصميم لوحة تحكم طالب الخدمة
- [ ] تبسيط القائمة الجانبية لتشمل فقط: تسجيل مسجد، طلب خدمة، طلباتي، مساجدي، الإشعارات
- [ ] إزالة جميع الروابط الإدارية من واجهة طالب الخدمة
- [ ] تحسين تجربة المستخدم لطالب الخدمة


## المرحلة 55: إصلاح ثغرة أمنية وحماية الصفحات الإدارية (2026-01-07)
- [x] إنشاء مكون AdminGuard لحماية الصفحات الإدارية
- [x] إضافة حماية على مستوى المسارات لمنع طالب الخدمة من الوصول للصفحات الإدارية
- [x] تحديث جميع المسارات الإدارية لاستخدام AdminRoute
- [x] إعادة توجيه طالب الخدمة تلقائياً إلى لوحة تحكمه الخاصة
- [x] تبسيط واجهة طالب الخدمة
- [x] إعادة تصميم لوحة تحكم طالب الخدمة بتصميم بسيط ومحدود الوظائف
- [x] عرض نسبة التقدم لكل طلب بدلاً من التفاصيل الداخلية
- [x] إضافة قسم الإشعارات في لوحة التحكم


## المرحلة 56: ملاحظات شاملة على النظام (2026-01-07)

### أولاً: ملاحظات حساب طالب الخدمة
- [x] تغيير حقل المدينة في تسجيل الحساب إلى قائمة منسدلة بمدن منطقة عسير
- [x] إزالة زر "جدولة الزيارة" من حساب طالب الخدمة
- [x] إضافة رابط موقع المسجد على خرائط Google مع خيار نسخ الرابط
- [x] إضافة زر العودة للشاشة الرئيسية في طلبات خدمات المساجد

### ثانياً: التعليقات والمرفقات
- [x] إخفاء التعليقات والمرفقات لطالب الخدمة (لأنها للموظفين فقط)
- [ ] عرض التعليقات وفق مراحل الطلب

### ثالثاً: مسار الزيارة الميدانية
- [x] إضافة زر إسناد المهمة لموظف محدد
- [x] إضافة زر جدولة الزيارة الميدانية
- [x] إنشاء نموذج جدولة الزيارة (اسم الشخص، الصفة، رقم الجوال، التاريخ، الوقت)
- [ ] إنشاء صفحة تقويم الزيارات
- [ ] منع تداخل الزيارات (مدة افتراضية ساعة واحدة)
- [ ] تنبيه عند محاولة جدولة زيارة في وقت محجوز

### رابعاً: عرض الطلبات والتنقل
- [ ] تمكين الضغط المباشر على الطلب للانتقال لصفحة التفاصيل

### خامساً: شاشة طلب عروض الأسعار
- [ ] توسيع الشاشة وتحسين التصميم
- [ ] توسيع حقل اسم المورد
- [ ] إبراز تاريخ آخر موعد لتقديم العرض
- [ ] إتاحة استيراد عروض الأسعار من Excel
- [ ] إتاحة استيراد جداول الكميات من Excel
- [ ] ربط الشاشة بقسم التعليقات والمرفقات

## المرحلة 57: ملاحظات المستخدم الجديدة (7 يناير 2026)

### أولاً: التسلسل الصارم للعمليات
- [ ] تفعيل التسلسل الصارم: الفرز → الزيارة الميدانية → الإسناد → الجدولة → التقرير
- [ ] منع الانتقال لأي مرحلة قبل إكمال المرحلة السابقة

### ثانياً: تحسين نموذج جدولة الزيارة
- [x] إضافة حقل اسم الشخص المسؤول الذي ستتم زيارته
- [x] إضافة حقل صفة الشخص (إدخال يدوي مرن)
- [x] إضافة حقل رقم جوال الشخص
- [x] إزالة زر جدولة الزيارة من صفحة المسجد

### ثالثاً: تحسين شاشة إضافة عرض السعر
- [x] تحسين تصميم شاشة إضافة عرض السعر (توسيع الشاشة، تحسين حقل المورد، إبراز تاريخ انتهاء العرض)

### رابعاً: تحسين قائمة الطلبات
- [x] تمكين الدخول المباشر للطلب بالضغط عليه من قائمة الطلبات

## مشكلة عاجلة - اختفاء البيانات
- [ ] التحقق من سبب اختفاء الطلبات
- [ ] التحقق من سبب اختفاء عروض الأسعار
- [ ] التحقق من سبب اختفاء جداول الكميات
- [ ] إصلاح المشكلة واستعادة البيانات


## إصلاح مشكلة اختفاء البيانات (2026-01-08)
- [x] التحقق من سبب اختفاء الطلبات - السبب: أعمدة جديدة غير موجودة في قاعدة البيانات
- [x] التحقق من سبب اختفاء عروض الأسعار - تعمل الآن
- [x] التحقق من سبب اختفاء جداول الكميات - تعمل الآن
- [x] إصلاح المشكلة - تم إضافة الأعمدة: fieldVisitContactName, fieldVisitContactTitle, fieldVisitContactPhone


## تحسين شاشة عروض الأسعار وجداول الكميات (2026-01-08)

### تحسين شاشة إضافة عرض السعر
- [x] توسيع الشاشة لإظهار كافة البيانات (1400px)
- [x] نقل اسم المورد للأعلى مع تصميم مميز
- [x] نقل التاريخ تحت اسم المورد مع عرض مفصل للتاريخ
- [x] تحسين ترتيب الحقول والتصميم العام

### إضافة خاصية استيراد Excel
- [x] إضافة زر استيراد الأسعار من Excel في شاشة عرض السعر
- [x] إضافة زر استيراد البنود من Excel في جداول الكميات
- [x] إنشاء قالب Excel للتحميل (لعروض الأسعار وجداول الكميات)


## تحسينات إضافية (2026-01-08)
- [x] توسيع نافذة إضافة عرض السعر بشكل أكبر لإظهار كافة البيانات (98vw)
- [x] تحويل قائمة الطلبات في جداول الكميات من قائمة منسدلة إلى بطاقات قابلة للاختيار


## تحسينات جديدة (2026-01-08)

### 1. تصدير عروض الأسعار كـ PDF
- [ ] إنشاء قالب PDF لعرض السعر
- [ ] إضافة زر تصدير PDF في صفحة عروض الأسعار
- [ ] تضمين تفاصيل المورد والبنود والأسعار في PDF

### 2. فلترة الطلبات في جداول الكميات
- [ ] إضافة فلتر حسب البرنامج
- [ ] إضافة فلتر حسب الحالة
- [ ] تحسين عرض البطاقات مع الفلترة

### 3. التسلسل الصارم للعمليات
- [ ] تحديد مراحل سير العمل وشروط كل مرحلة
- [ ] تنفيذ التحقق من الشروط قبل الانتقال
- [ ] إضافة رسائل توضيحية للمستخدم عند عدم استيفاء الشروط
- [ ] تعطيل الأزرار غير المتاحة في كل مرحلة


## المرحلة 26: التسلسل الصارم للعمليات مع المدد الزمنية

### تصميم النظام
- [ ] إضافة حقول المدة الزمنية لكل مرحلة في schema
- [ ] إضافة حقل تاريخ بداية كل مرحلة (stageStartedAt)
- [ ] إضافة حقل تاريخ الاستحقاق (stageDueAt)
- [ ] إضافة حقل حالة التأخير (isDelayed)

### المدد الزمنية لكل مرحلة
- [ ] تقديم الطلب: 1 يوم
- [ ] المراجعة الأولية: 3 أيام
- [ ] الزيارة الميدانية: 7 أيام
- [ ] إعداد جدول الكميات: 5 أيام
- [ ] التقييم المالي: 10 أيام
- [ ] اعتماد العرض: 3 أيام
- [ ] التعاقد: 5 أيام
- [ ] التنفيذ: حسب المشروع
- [ ] الاستلام: 7 أيام
- [ ] الإغلاق: 14 يوم

### نظام التصعيد
- [ ] تنبيه للموظف المسؤول عند تجاوز المدة
- [ ] تصعيد للمدير المباشر بعد يوم إضافي
- [ ] تصعيد للمدير التنفيذي بعد 3 أيام إضافية

### مراحل التنفيذ (لكل مرحلة مشروع)
- [ ] تقرير إنجاز
- [ ] طلب صرف
- [ ] أمر صرف

### مرحلة الاستلام
- [ ] التقرير الختامي
- [ ] الدفعة الختامية
- [ ] محضر الاستلام

### مرحلة الإغلاق
- [ ] قياس رضا أصحاب المصلحة
- [ ] قياس رضا المستفيدين
- [ ] عمليات النشر
- [ ] التغذية الراجعة


## المرحلة 27: التسلسل الصارم للعمليات (مكتمل)

### 1. تصدير عروض الأسعار كـ PDF
- [x] إضافة مكتبة jspdf و jspdf-autotable
- [x] إنشاء دالة exportQuotationToPDF
- [x] إضافة زر تصدير PDF لكل عرض سعر
- [x] دعم اللغة العربية في PDF

### 2. فلترة الطلبات في جداول الكميات
- [x] إضافة فلتر حسب البرنامج
- [x] إضافة فلتر حسب الحالة
- [x] تحديث عرض البطاقات حسب الفلاتر

### 3. نظام إعدادات المراحل
- [x] إنشاء جدول stageSettings في قاعدة البيانات
- [x] إنشاء جدول requestStageTracking لتتبع المدد
- [x] إنشاء router لإعدادات المراحل
- [x] إنشاء صفحة إعدادات المراحل في الواجهة
- [x] إمكانية تخصيص المدة لكل مرحلة
- [x] إمكانية تخصيص مستويات التصعيد

### 4. تتبع المدد الزمنية
- [x] تسجيل بداية كل مرحلة تلقائياً
- [x] حساب تاريخ الاستحقاق بناءً على المدة المحددة
- [x] تتبع التأخير في كل مرحلة

### 5. نظام التصعيد (للتطوير المستقبلي)
- [ ] إشعار الموظف المسؤول عند اقتراب انتهاء المدة
- [ ] تصعيد للمدير المباشر بعد يوم إضافي
- [ ] تصعيد للمدير التنفيذي بعد 3 أيام إضافية
- [ ] لوحة عرض الإجراءات المتأخرة


## إصلاحات عاجلة (2026-01-08)
- [x] إنشاء جدول stage_settings في قاعدة البيانات
- [x] إنشاء جدول request_stage_tracking
- [x] إنشاء جدول escalation_logs
- [x] تحديث ترتيب المراحل في صفحة الطلبات (10 مراحل جديدة)


## المرحلة 28: الهيكل الشامل للمراحل (2026-01-11)

### تحديث المراحل الرئيسية
- [ ] إضافة مرحلة التقييم الفني بعد الزيارة الميدانية (اعتذار، تعليق، استجابة سريعة، تحويل لمشروع)
- [ ] تغيير "التنفيذ" إلى "تحويل إلى مشروع" في مسار المشروع
- [ ] توحيد مرحلة الإغلاق لجميع المسارات (استجابة سريعة ومشروع)

### نظام المراحل الفرعية (الإجراءات)
- [ ] إنشاء جدول الإجراءات الفرعية في قاعدة البيانات (sub_stages)
- [ ] ربط الإجراءات بالمراحل الرئيسية
- [ ] إضافة المدد الزمنية للإجراءات الفرعية
- [ ] الإجراءات الفرعية للزيارة الميدانية: إسناد الزيارة → جدولة الزيارة → تنفيذ الزيارة → رفع التقرير
- [ ] الإجراءات الفرعية للاستلام: الاستلام الابتدائي → فترة الضمان → الاستلام النهائي → التقرير الختامي → الدفعة الختامية

### تغيير الأيقونات
- [ ] تغيير أيقونات البرامج (سقيا، دعائم، بنيان) من إيموجي إلى أيقونات متناسقة
- [ ] استخدام أيقونات بألوان أخضر/ذهبي تتناسب مع تصميم البوابة

### تحديث صفحة الإعدادات
- [ ] عرض المراحل الفرعية في صفحة إعدادات المراحل
- [ ] إمكانية تخصيص المدد لكل إجراء فرعي


## المرحلة 31: تحديث المراحل إلى 11 مرحلة مع المراحل الفرعية

### تحديث قاعدة البيانات
- [x] تحديث requestStages enum في schema.ts لتشمل المراحل الـ 11
- [x] إضافة حقل subStageCode إلى جدول request_stage_tracking
- [x] إنشاء جدول request_sub_stage_tracking للمراحل الفرعية
- [x] تشغيل db:push لتطبيق التغييرات

### تحديث الثوابت
- [x] تحديث STAGE_LABELS في shared/constants.ts
- [x] تحديث STAGE_SUBSTEPS للمراحل الجديدة
- [x] تحديث REQUEST_TRACKS للمسارات الجديدة
- [x] تحديث STAGE_PREREQUISITES للشروط الجديدة
- [x] تحديث STAGE_TRANSITION_PERMISSIONS للصلاحيات الجديدة
- [x] تحديث getNextStage و getStageOrder

### تحديث Router
- [x] تحديث stageSettings router بالمراحل الـ 11 الافتراضية
- [x] إضافة المراحل الفرعية الافتراضية
- [x] إضافة procedures لتتبع المراحل الفرعية

### تحديث Frontend
- [x] تحديث stageSteps في RequestDetails.tsx
- [x] تحديث TECHNICAL_EVAL_OPTIONS لتوجيه convert_to_project إلى boq_preparation
- [x] تحديث SmartStatusBar لعرض المراحل الـ 11
- [x] تحديث صفحة إعدادات المراحل
- [x] تحديث شريط التقدم في صفحة تفاصيل الطلب

### المراحل الـ 11 الجديدة:
1. تقديم الطلب (submitted)
2. المراجعة الأولية (initial_review)
3. الزيارة الميدانية (field_visit)
4. التقييم الفني (technical_eval)
5. إعداد جدول الكميات (boq_preparation) - جديدة
6. التقييم المالي (financial_eval)
7. اعتماد العرض (quotation_approval) - جديدة
8. التعاقد (contracting) - جديدة
9. التنفيذ (execution)
10. الاستلام (handover) - جديدة (بدلاً من delivery)
11. الإغلاق (closed)



## المرحلة 32: إصلاح عرض المراحل في صفحة الإعدادات
- [ ] التحقق من وجود مرحلة التقييم الفني في قاعدة البيانات
- [ ] تهيئة المراحل الـ 11 بشكل صحيح
- [ ] التحقق من الأيقونات في شريط التقدم


## المرحلة 33: تحسينات واجهة المستخدم
- [ ] إضافة المراحل الفرعية القابلة للتخصيص في صفحة إعدادات المراحل
- [ ] استبدال الإيموجي بأيقونات Lucide احترافية في جميع الصفحات
- [ ] تحسين تصميم لوحة التحكم الرئيسية لتكون أكثر احترافية


## المرحلة 33: تحسينات واجهة المستخدم (مكتملة)
- [x] إضافة المراحل الفرعية في صفحة إعدادات المراحل
- [x] استبدال الإيموجي بأيقونات Lucide احترافية في جميع الصفحات
- [x] تحسين تصميم لوحة التحكم الرئيسية
- [x] إنشاء مكون ProgramIcon لعرض أيقونات البرامج
- [x] تحديث Dashboard.tsx بتصميم احترافي جديد
- [x] تحديث MyRequests.tsx
- [x] تحديث Requests.tsx
- [x] تحديث RequestDetails.tsx
- [x] تحديث RequesterDashboard.tsx
- [x] تحديث TrackRequest.tsx
- [x] تحديث Branding.tsx


## المرحلة 34: إزالة الإشارات إلى "تسعة" من البوابة
- [x] تعديل Home.tsx - إزالة "تسعة برامج" و"تسعة خدمات"
- [x] تعديل MosqueServiceRequest.tsx - إزالة "الخدمات التسعة"
- [x] تعديل index.css - إزالة "البرامج التسعة"
- [x] تعديل constants.ts - إزالة "الأدوار التسعة" و"البرامج التسعة"


## المرحلة 35: إصلاح مشاكل عروض الأسعار والعقود
- [ ] إصلاح خطأ 404 عند مراجعة العروض - إنشاء صفحة /requests/:id/quotations
- [ ] إضافة حقول الضريبة (15% قابلة للتخصيص) والخصم (نسبة أو مبلغ) لعروض الأسعار
- [ ] إصلاح زر الخريطة في معلومات المورد
- [ ] إصلاح تصدير عرض سعر PDF
- [ ] اختيار المورد المعتمد تلقائياً عند إنشاء عقد جديد
- [ ] مزامنة شريط التقدم العلوي مع التقدم الفعلي للمشروع
- [ ] إصلاح خطأ التحويل للمرحلة التالية (المراحل الجديدة غير موجودة في القائمة)


## المرحلة 36: إصلاح عدم التزامن بين الشريطين
- [x] تحليل الفرق بين شريط التقدم العلوي و SmartStatusBar
- [x] مزامنة المرحلة الحالية في كلا الشريطين (عرض اسم المرحلة الرئيسية + الخطوة الفرعية)
- [x] التحقق من صحة نسبة الإنجاز (55% لمرحلة التقييم المالي)


## إصلاح خطأ استعلام عروض الأسعار (2026-01-11)
- [x] إصلاح خطأ Failed query في جلب عروض الأسعار من جدول quotations (تحديد الأعمدة في select)


## المرحلة 37: تطوير شامل لصفحة الطلبات (2026-01-13)

### إصلاح المشاكل الحالية (المرحلة الأولى - أولوية قصوى)
- [x] تحليل آلية تحديث المراحل الحالية
- [x] إصلاح مزامنة الحالة التلقائية عند اعتماد العقد (تحديث stage إلى execution)
- [x] تطبيق قاعدة الزر الواحد النشط (Single Active Action) - عرض زر مناسب لكل مرحلة
- [x] توحيد عرض المرحلة الحالية في جميع المكونات - SmartStatusBar محدث
- [x] إضافة مكون StatusBadge موحد

### تطوير الحركة المالية (المرحلة 3 - قيد التنفيذ)
- [x] تحليل النظام المالي الحالي (schema, routers, واجهات)
- [x] تصميم لوحة التحكم المالية الموحدة (مع مؤشرات بصرية وتبويبات)
- [x] إضافة procedure getFinancialSummary في disbursements router
- [x] إنشاء صفحة /financial-dashboard
- [x] إضافة اختبارات unit test للوحة التحكم المالية (4 اختبارات)
- [x] تحسين واجهة طلبات الصرف:
  - [x] إضافة مؤشرات بصرية ملونة للحالة (DisbursementStatusBadge)
  - [x] إضافة تصفية متقدمة (نوع الدفعة)
  - [x] تحديث منطق التصفية filteredRequests
- [x] تحسين واجهة أوامر الصرف:
  - [x] إضافة مؤشرات بصرية ملونة للحالة (DisbursementStatusBadge)
  - [x] ربط أمر الصرف بطلب الصرف (موجود requestNumber في الجدول)
- [x] ربط طلبات الصرف بأوامر الصرف (موجود disbursementRequestId)
- [ ] نظام الدفعة الختامية (Final Payment):
  - [x] تحليل متطلبات الدفعة الختامية والشروط المسبقة
  - [x] إضافة جداول handovers, satisfactionSurveys, surveyResponses في schema
  - [x] إنشاء handovers router مع procedures (إنشاء، قائمة، اعتماد، رفض، إكمال)
  - [x] إضافة procedure checkFinalPaymentPrerequisites
  - [ ] إنشاء واجهات الاستلام (أولي، ضمان، نهائي):
  - [x] إنشاء صفحة قائمة الاستلامات (/handovers) مع تصفية حسب النوع والحالة
  - [x] إضافة مكون HandoverStatusBadge لعرض الحالة
  - [x] تحديث handovers router لإرجاع projectNumber
  - [ ] إنشاء صفحة إنشاء استلام جديد (/handovers/new) مع رفع ملفات وصور
  - [ ] إنشاء صفحة تفاصيل الاستلام (/handovers/:id) مع إمكانية الاعتماد/الرفض
- [ ] إنشاء واجهة خاصة للدفعة الختامية
  - [ ] ربط الدفعة الختامية بمرحلة الإغلاق
- [ ] عرض ملخص الحركة المالية للمشروع

### نماذج الاستلام
- [ ] إكمال نموذج الاستلام الأولي (Preliminary Handover)
- [ ] إكمال نموذج فترة الضمان (Warranty Period)
- [ ] إكمال نموذج الاستلام النهائي (Final Handover)
- [ ] إضافة تقرير الاستلام النهائي

### نماذج قياس الرضا
- [ ] إضافة نموذج قياس رضا أصحاب المصلحة (Stakeholder Satisfaction)
- [ ] إضافة نموذج قياس رضا المستفيدين (Beneficiary Satisfaction)
- [ ] عرض نتائج قياس الرضا في لوحة التحكم


## إصلاح مشكلة تحديث currentStage عند اعتماد العقد
- [x] تحليل السبب الجذري للمشكلة
- [x] التحقق من الكود في contracts.ts (approve procedure)
- [x] التحقق من الكود في ContractForm.tsx
- [x] إضافة console.log للتتبع في contracts.ts
- [x] إضافة console.warn عند إنشاء عقد بدون requestId
- [x] إضافة تحذير في واجهة إنشاء العقد عندما لا يتم تمرير requestId
- [x] تحديث الطلب 120001 يدوياً إلى مرحلة execution
- [x] إنشاء تقرير شامل عن المشكلة والحل


## إصلاح خطأ SQL عند التحويل إلى مشروع
- [ ] تحليل الخطأ في SQL query (currentStage = boq_preparation غير صحيح)
- [ ] تحديد الكود المسؤول عن التحويل إلى مشروع
- [ ] إصلاح currentStage ليكون "execution" بدلاً من "boq_preparation"
- [ ] إصلاح status ليكون "in_progress" بدلاً من "approved"
- [ ] اختبار التحويل إلى مشروع بعد الإصلاح


## إصلاح خطأ SQL عند التحويل إلى مشروع (2026-01-13)
- [x] تحليل سبب خطأ "Data Too Long" عند التحويل إلى مشروع
- [x] إصلاح resultStatus في constants.ts (من 'approved' إلى 'in_progress')
- [x] تعديل enum currentStage في قاعدة البيانات لدعم جميع المراحل
- [x] اختبار الإصلاح وتأكيد نجاحه


## إعادة تصميم صفحة تفاصيل الطلب - تصميم مركزي وإجراءات ديناميكية (2026-01-13)

### المرحلة 1: إنشاء المكونات الأساسية الجديدة
- [ ] إنشاء مكون ActiveActionCard لعرض الإجراء النشط
- [ ] إنشاء مكون ProjectInfoDrawer للمعلومات الأساسية (Drawer منزلق)
- [ ] إنشاء مكون TimelineDrawer للسجل الزمني (Drawer منزلق)
- [ ] إنشاء مكون AttachmentsDrawer للمرفقات (Drawer منزلق)
- [ ] إنشاء مكون CommentsDrawer للتعليقات (Drawer منزلق)
- [ ] إنشاء مكون ProgressStepper لشريط التقدم المبسط

### المرحلة 2: تطبيق منطق العرض الديناميكي
- [ ] إنشاء دالة getActiveAction(currentStage, userRole, requestData) لتحديد الإجراء النشط
- [ ] إنشاء دالة getActionConfig(stage) لتحديد تكوين كل إجراء (العنوان، الوصف، الزر، الأيقونة)
- [ ] إنشاء ثوابت ACTION_CONFIGS في shared/constants.ts
- [ ] تطبيق الشروط المسبقة (Prerequisites) لكل إجراء

### المرحلة 3: إعادة هيكلة صفحة RequestDetails
- [ ] إعادة تصميم البنية العامة للصفحة (Header + Tabs + Central Content)
- [ ] إضافة Header مع معلومات الطلب الأساسية
- [ ] إضافة شريط التبويبات العلوي (معلومات المشروع، السجل، المرفقات، التعليقات)
- [ ] إضافة المحتوى المركزي مع ActiveActionCard
- [ ] إخفاء جميع الأزرار القديمة وعرض الإجراء النشط فقط
- [ ] تطبيق التصميم المركزي (max-width, centered)

### المرحلة 4: اختبار جميع المراحل
- [ ] اختبار مرحلة تقديم الطلب (submitted)
- [ ] اختبار مرحلة المراجعة الأولية (initial_review)
- [ ] اختبار مرحلة الزيارة الميدانية (field_visit)
- [ ] اختبار مرحلة التقييم الفني (technical_eval) - الخيارات الأربعة
- [ ] اختبار مرحلة إعداد جدول الكميات (boq_preparation)
- [ ] اختبار مرحلة التقييم المالي (financial_eval)
- [ ] اختبار مرحلة التعاقد (contracting)
- [ ] اختبار مرحلة التنفيذ (execution)
- [ ] اختبار مرحلة الإغلاق (closed)
- [ ] التأكد من عمل Drawers بشكل صحيح
- [ ] التأكد من الصلاحيات تعمل بشكل صحيح


## إعادة تصميم صفحة تفاصيل الطلب - التصميم المركزي (2026-01-14)
- [x] إنشاء ActiveActionCard
- [x] إنشاء InfoDrawer
- [x] إنشاء ProgressStepper
- [x] إضافة ACTION_CONFIGS
- [x] إنشاء getActiveAction
- [x] إعادة هيكلة RequestDetails.tsx
- [x] اختبار التصميم الجديد
- [x] ربط زر "الانتقال للمرحلة التالية" بـ updateStage mutation
- [x] ربط زر "إضافة تعليق" بـ addComment mutation (يفتح drawer)
- [x] ربط زر "رفع مرفق" بـ uploadAttachment mutation (يفتح drawer)
- [x] إضافة redirectUrl للمراحل التي تحتاج صفحات خاصة
- [ ] إضافة معالجة مرحلة التقييم الفني (الخيارات الأربعة)
- [ ] اختبار جميع المراحل والصلاحيات
