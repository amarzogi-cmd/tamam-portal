# TODO - بوابة تمام للعناية بالمساجد

## المرحلة 51: إصلاح المشاكل الحرجة
- [x] إصلاح ترتيب مراحل الزيارة الميدانية (الخطأ: يطلب تقرير قبل الجدولة!)
  - المشكلة: النظام يطلب تقرير ميداني قبل جدولة الزيارة (منطقياً التقرير يأتي بعد الزيارة)
  - الحل: تعديل stageActionConfig ليحتوي على 4 مراحل: إسناد → جدولة → تنفيذ → تقرير
- [x] إصلاح صفحة المستخدمين (التحديثات لم تظهر)
  - المشكلة: التعديلات على الأزرار والخدمات لم تظهر في الواجهة
  - الحل: استبدال Users.tsx بـ UsersManagement.tsx في App.tsx
- [x] التحقق من واجهة تخصيص الصلاحيات
  - النتيجة: نظام الصلاحيات موجود ومكتمل 100% ويعمل بشكل ممتاز
  - الميزات: إسناد أدوار، صلاحيات فردية، 10 أقسام × 7 صلاحيات لكل قسم

## المرحلة 52: إصلاح منطق أزرار الزيارة الميدانية (المشكلة لا زالت قائمة!)
- [ ] المشكلة: زر "جدولة الزيارة" يحاول الانتقال للمرحلة التالية بدلاً من فتح نافذة الجدولة فقط
- [ ] الحل المطلوب: تغيير منطق الأزرار لتكون إجراءات داخلية (internal actions) بدلاً من الانتقال للمرحلة التالية
- [ ] التسلسل الصحيح: جدولة (dialog) → تنفيذ (dialog) → رفع تقرير (dialog) → ثم الانتقال للمرحلة التالية

## المرحلة 53: إنشاء صفحات الزيارة الميدانية
- [x] إنشاء صفحة جدولة الزيارة (/field-visits/schedule/:requestId)
  - نموذج لتحديد تاريخ ووقت الزيارة
  - اختيار الفريق الميداني
  - حفظ البيانات في قاعدة البيانات
- [x] إنشاء صفحة تنفيذ الزيارة (/field-visits/execute/:requestId)
  - نموذج لتأكيد تنفيذ الزيارة
  - تسجيل تاريخ التنفيذ الفعلي
  - ملاحظات التنفيذ
- [x] إنشاء جدول field_visits في قاعدة البيانات
- [x] إنشاء fieldVisitsRouter في Backend
- [x] إضافة المسارات الثلاثة في App.tsx
- [x] تعديل constants.ts لإضافة redirectUrl لزر field_visit
- [ ] إصلاح checkCompletion في stageActionConfig.ts (يبحث عن حقول غير موجودة في request)
- [ ] اختبار التدفق الكامل: جدولة → تنفيذ → رفع تقرير → انتقال للمرحلة التالية

## المرحلة 54: إكمال إصلاح منطق الزيارة الميدانية
- [x] إصلاح checkCompletion فيRequestDetailsNew.tsx للاستعلام من جدول field_visits
- [x] اختبار التدفق الكامل: جدولة → تنفيذ → رفع تقرير → انتقال للمرحلة التالية
- [x] تحسين UX بإضافة مؤشرات بصرية لحالة كل إجراء (مكتمل/قيد التنفيذ/معلق)

## المرحلة 55: إصلاح المشاكل المكتشفة في التجربة
- [ ] إصلاح خطأ SQL في المراجعة الأولية (Failed query: insert into request_stage_tracking)
- [x] حذف مرحلة "تأكيد تنفيذ الزيارة الميدانية" (مرحلة مكررة لا حاجة لها)
  - حذف صفحة /field-visits/execute
  - حذف إجراء execute_field_visit من stageActionConfig
  - تعديل التدفق: جدولة → رفع تقرير مباشرة
  - حذف المسار من App.tsx
  - تحديث RequestDetailsNew.tsx لتخطي execute_field_visit
  - تحديث المؤشرات البصرية لتعرض إجراءين فقط
- [x] إنشاء شاشة منبثقة شاملة تحتوي على:
  - معلومات الطلب (المسجد ومقدم الطلب)
  - المرفقات (مع إمكانية التحميل والعرض)
  - التعليقات (مع إمكانية إضافة تعليق جديد)
  - زر "عرض التفاصيل الكاملة" في صفحة تفاصيل الطلب
- [ ] تحسين نظام التعليقات:
  - إضافة تنبيهات للتعليقات الجديدة/غير المقروءة
  - إمكانية طلب مرفقات أو إجراءات من الفريق الداخلي
  - جعلها أكثر فائدة في مراحل العمل
- [ ] إضافة جدول للزيارات الميدانية مع إدارة التعارضات
- [ ] إعادة النظر في السجل الزمني (دمجه في الشاشة المنبثقة أو حذفه)

## المرحلة 56: إنشاء نظام تسجيل دخول بكلمة مرور وحسابات تجريبية
- [ ] إنشاء نظام تسجيل دخول بكلمة مرور (بدلاً من OAuth فقط)
- [ ] إنشاء حسابات تجريبية بأدوار مختلفة للاختبار
- [ ] إنشاء سكريبت لإنشاء/إعادة تعيين كلمات المرور

## المرحلة 57: تحسينات واجهة تفاصيل الطلب والميزات الجديدة

- [x] تحويل الخيارات العلوية (معلومات المشروع، السجل الزمني، المرفقات، التعليقات) إلى نوافذ منبثقة
  - [x] تمييز كل خيار بلون مستقل (أزرق، أخضر، برتقالي، بنفسجي)
  - [x] إضافة زر رجوع في كل نافذة منبثقة
  - [x] عرض اللون المميز في النافذة المنبثقة
- [x] إضافة بيانات تجريبية للتعليقات والمرفقات
  - [x] إضافة 5 تعليقات تجريبية لطلب موجود
  - [x] إضافة 3 مرفقات تجريبية لطلب موجود
  - [x] التأكد من ظهور البيانات في جميع الخيارات العلوية
- [x] تحسين نافذة التفاصيل الكاملة
  - [x] إضافة خلفية تركوازية لاسم المسجد
  - [x] إضافة خلفية ذهبية لطالب الخدمة
- [x] إضافة نظام تنبيهات للتعليقات
  - [x] عرض عدد التعليقات غير المقروءة (badge أحمر)
  - [x] تحديث التعليقات كمقروءة عند فتح النافذة
  - [x] تحديث حالة "مقروء/غير مقروء" للتعليقات
  - [x] إضافة حقل isRead في جدول request_comments
- [x] إنشاء جدول زمني للزيارات الميدانية
  - [x] عرض تقويمي للزيارات المجدولة
  - [x] كشف التعارضات الزمنية تلقائياً
  - [x] قائمة تفصيلية بالزيارات مع ألوان مميزة لكل برنامج
  - [x] عرض زيارات اليوم المحدد في بطاقة جانبية
- [x] إنشاء حسابات تجريبية بأدوار مختلفة
  - [x] حساب مدير المشاريع (project.manager@test.tamam.sa)
  - [x] حساب فريق ميداني (field.team@test.tamam.sa)
  - [x] حساب مكتب المشاريع (projects.office@test.tamam.sa)
  - [x] حساب الشؤون المالية (financial@test.tamam.sa)
  - [x] حساب طالب خدمة (requester@test.tamam.sa)

## المرحلة 58: إضافة نظام تسجيل دخول بكلمة مرور

- [x] تحديث schema بإضافة حقل passwordHash في جدول users (موجود بالفعل)
- [x] تطبيق التغييرات على قاعدة البيانات (موجود بالفعل)
- [x] إنشاء router للمصادقة (authRouter) يدعم:
  - [x] تسجيل الدخول بالبريد وكلمة المرور
  - [x] تشفير كلمات المرور باستخدام pbkdf2
  - [x] إنشاء JWT token
- [x] تحديث واجهة تسجيل الدخول لدعم البريد وكلمة المرور (موجود بالفعل)
- [x] إنشاء كلمات مرور موحدة للحسابات التجريبية (Test@123456)
- [x] اختبار تسجيل الدخول بجميع الحسابات التجريبية
- [x] توثيق بيانات الدخول للحسابات التجريبية

## إصلاح مشكلة عدم ظهور تفاصيل الطلبات

- [x] تشخيص المشكلة: حقل isRead مفقود في جدول request_comments في قاعدة البيانات
- [x] إضافة حقل isRead إلى قاعدة البيانات باستخدام ALTER TABLE
- [x] التحقق من عمل صفحة تفاصيل الطلب بعد الإصلاح

## المرحلة 59: إصلاح مشاكل التعليقات والمرفقات وتحسينات UX

- [x] إصلاح مشكلة إضافة التعليقات
  - [x] التأكد من ظهور محتوى التعليق (حالياً يظهر المرسل فقط)
  - [x] إضافة رسالة تأكيد بعد إرسال التعليق
  - [x] فصل وظيفة الإضافة عن الاستعراض (زر أسفل للإضافة، زر أعلى للاستعراض)

- [x] إصلاح مشكلة إضافة المرفقات
  - [x] التأكد من عمل زر إضافة مرفق
  - [x] إضافة رسالة تأكيد بعد رفع المرفق
  - [x] فصل وظيفة الإضافة عن الاستعراض

- [x] تحسين ألوان الأزرار العلوية
  - [x] تغيير الأزرار إلى خلفية ملونة + نص أبيض
  - [x] تناسق الألوان المختارة مع هوية البوابة (تركواز + ذهبي)

- [x] توحيد رسائل التنبيهات
  - [x] جعل جميع التنبيهات تظهر في موقع واحد (أعلى اليمين لدعم RTL)
  - [x] توحيد شكل وتصميم رسائل التنبيهات باستخدام مكتبة sonner

- [x] إضافة زر رجوع في صفحة إدارة المستخدمين
  - [x] إضافة زر "رجوع" في أعلى الصفحة

## المرحلة 60: إصلاح مشاكل التعليقات والمرفقات والزيارات الميدانية

- [x] إصلاح عرض محتوى التعليقات في النافذة المنبثقة العلوية
  - [x] يظهر المرسل فقط بدون محتوى التعليق (الحقل كان comment وليس content)
  - [x] إصلاح عرض نص التعليق كاملاً

- [x] إصلاح واجهة إضافة التعليقات في الأسفل
  - [x] إنشاء نافذة منفصلة لإضافة التعليقات
  - [x] إضافة textarea لكتابة التعليق الجديد
  - [x] رسالة تأكيد بعد إضافة التعليق

- [x] إصلاح واجهة المرفقات العلوية
  - [x] المرفقات تعرض بشكل صحيح

- [x] إصلاح واجهة إضافة المرفقات في الأسفل
  - [x] إنشاء نافذة منفصلة لرفع المرفقات
  - [x] إضافة input file picker
  - [x] رفع الملف إلى S3 باستخدام uploadRequestAttachment
  - [x] رسالة تأكيد بعد رفع المرفق

- [x] تحسين جدولة الزيارة الميدانية
  - [x] تغيير حقل "الفريق الميداني" إلى "إسناد المهمة إلى" بقائمة منسدلة
  - [x] إضافة procedure getStaffUsers في usersRouter
  - [x] جلب قائمة المستخدمين الموظفين (ما عدا service_requester)
  - [x] إضافة حقل assignedTo في جدول field_visits
  - [x] تعديل scheduleVisit لقبول assignedUserId

- [x] إصلاح زر الرجوع في صفحة إدارة المستخدمين
  - [x] تغيير الرابط من "/" إلى "/dashboard"
  - [x] إضافة نص توضيحي "رجوع إلى لوحة التحكم"

- [x] إصلاح رسائل خطأ SQL
  - [x] خطأ request_stage_tracking: إزالة isDelayed و delayDays من insert (لها قيم افتراضية)
  - [x] خطأ request_history: تغيير fromStage, toStage, fromStatus, toStatus من enum إلى varchar nullable
  - [x] تطبيق التغييرات على قاعدة البيانات (migration 0047)- [x] إضافة صفحة تقويم المواعيد المجدولة
  - [x] الصفحة موجودة بالفعل في /field-visits/calendar
  - [x] تعرض تقويماً شهرياً مع كشف التعارضات
  - [x] إضافة رابط في القائمة الجانبية للمدراء والفريق الميداني